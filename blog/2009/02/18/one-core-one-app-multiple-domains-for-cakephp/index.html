
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>One core, one app, multiple domains for CakePHP - My New Home</title>
  <meta name="author" content="Martin Westin">

  
  <meta name="description" content="Dealing with configurations for multiple domains (environments) is always a topic for discussion. I wanted to share my way of dealing with this &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://eimer.co/blog/2009/02/18/one-core-one-app-multiple-domains-for-cakephp">
  <link href="/favicon.ico" rel="icon">

  <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/font-awesome/css/font-awesome.css" rel="stylesheet" type="text/css">
  <link href="/assets/js/prettify.css" rel="stylesheet" type="text/css">

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

  <link href="" rel="alternate" title="My New Home" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11893308-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    data-spy="scroll">

  <div class="container">
    <header class="jumbotron subhead" id="overview">
      <h1 class="title">My New Home</h1>

  <p class="lead">migrated from the 10 year-old eimermusic.com</p>


      <div class="navbar">
  <div class="navbar-inner">
    <div class="container" style="width: auto;">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <div class="nav-collapse">
                <ul class="nav">
          <li><a href="/">Home</a></li>
          <li><a href="/music">Music</a></li>
          <li><a href="/photos">Photos</a></li>
          <li><a href="/portfolio">Portfolio</a></li>
          <li><a href="/about">About</a></li>
        </ul>

        
          <form action="http://google.com/search" method="get" class="navbar-search pull-left">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:eimer.co" />
              <input type="text" name="q" results="0" placeholder="Search" class="search-query span2" />
            </fieldset>
          </form>
        
        
      </div><!-- /.nav-collapse -->
    </div>
  </div><!-- /navbar-inner -->
</div>

      <section class="well">
  <a class="label" href="/tag/character set">character set (3)</a> <a class="label" href="/tag/collation">collation (3)</a> <a class="label" href="/tag/mysql">mysql (8)</a> <a class="label" href="/tag/bash">bash (1)</a> <a class="label" href="/tag/command">command (1)</a> <a class="label" href="/tag/rm">rm (1)</a> <a class="label" href="/tag/svn">svn (1)</a> <a class="label" href="/tag/convert">convert (1)</a> <a class="label" href="/tag/characters">characters (1)</a> <a class="label" href="/tag/replace">replace (1)</a> <a class="label" href="/tag/insert">insert (1)</a> <a class="label" href="/tag/select">select (1)</a> <a class="label" href="/tag/copy">copy (1)</a> <a class="label" href="/tag/permissions">permissions (1)</a> <a class="label" href="/tag/duplicates">duplicates (1)</a> <a class="label" href="/tag/cakephp">cakephp (5)</a> <a class="label" href="/tag/guide">guide (1)</a> <a class="label" href="/tag/migration">migration (1)</a> <a class="label" href="/tag/authentication">authentication (1)</a> <a class="label" href="/tag/http">http (1)</a> <a class="label" href="/tag/security">security (2)</a> <a class="label" href="/tag/find">find (1)</a> <a class="label" href="/tag/position">position (1)</a> <a class="label" href="/tag/vhosts">vhosts (1)</a> <a class="label" href="/tag/olap">olap (1)</a> <a class="label" href="/tag/reporting">reporting (1)</a> <a class="label" href="/tag/schema">schema (1)</a> <a class="label" href="/tag/star">star (1)</a> <a class="label" href="/tag/javascript">javascript (1)</a> <a class="label" href="/tag/scope">scope (1)</a> <a class="label" href="/tag/variables">variables (1)</a> <a class="label" href="/tag/design">design (2)</a> <a class="label" href="/tag/modular">modular (1)</a> <a class="label" href="/tag/plugins">plugins (1)</a> <a class="label" href="/tag/array">array (1)</a> <a class="label" href="/tag/php">php (2)</a> <a class="label" href="/tag/css">css (1)</a> <a class="label" href="/tag/projekktor">projekktor (1)</a> <a class="label" href="/tag/espresso">espresso (2)</a> <a class="label" href="/tag/extraction">extraction (3)</a> <a class="label" href="/tag/iphone">iphone (5)</a> <a class="label" href="/tag/bugs">bugs (1)</a> <a class="label" href="/tag/memory warning">memory warning (1)</a> <a class="label" href="/tag/nginx">nginx (2)</a> <a class="label" href="/tag/wordpress">wordpress (2)</a> <a class="label" href="/tag/mime">mime (1)</a> <a class="label" href="/tag/ruby">ruby (4)</a> <a class="label" href="/tag/savon">savon (1)</a> <a class="label" href="/tag/soap">soap (1)</a> <a class="label" href="/tag/rails">rails (2)</a> <a class="label" href="/tag/devise">devise (1)</a> 
</section>
    </header>
    <div id="main">
      <div id="content">
        <div class="row">
  
  <div class="span8">
    
  <header>
    
      <h1 class="entry-title">One Core, One App, Multiple Domains for CakePHP</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-18T00:00:00+01:00" pubdate data-updated="true">Feb 18<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  
  
  <div class="entry-content"><p>
Dealing with configurations for multiple domains (environments) is always a topic for discussion. I wanted to share my way of dealing with this common problem. This will not be right for all, which is the point. If this does not suit you, there are a few links at the bottom.
</p>


<h3>What will this do?</h3>

<p>
Simplify updates using SCM (git pull anyone?).<br />
Ability to run a single vhost setting, single cake core, single app directory for multiple subdomains.<br />
Each subdomain is it&#8217;s own application not simply an alias.<br />
Can run domain-sensitive shell tasks.
</p>


<h3>Apache first.</h3>

<p>
(or whatever you use)<br />
Just create a vhost and keep adding aliases for each new domain. 
</p>


<pre class="prettyprint linenums" lang="">
ServerName client1.example.com
ServerAlias client2.example.com
ServerAlias client3.example.com
</pre>


<p>
(I don&#8217;t like wildcards here since I want any non-existing sub-domains to point to a non-cake &#8220;error site&#8221;)
</p>


<h3>Now Cake.</h3>

<p>
The domain switching is handled in bootstrap.php by looking at the HTTP_HOST environment variable. THis is not perfect. But I think it&#8217;s preferable to something like using &#8220;SetEnv&#8221; in htaccess or the vhost. This is simply because that if Apache isn&#8217;t providing the server name then you probably can&#8217;t see the set parameter either.
Shell access, you say? Well, that is where the first of the two if clauses in bootstrap.php comes in. More on that in a minute.
</p>




<h4>bootstrap.php</h4>


<pre class="prettyprint linenums" lang="php">
&lt;?php
// Initial defaults go at the top, for example:
Configure::write('Config.language', 'swe');


// Load domain-specific config
if ( isset($_SERVER['HTTP_HOST']) ) { // web
    $bootstrap = CONFIGS .'domains'.DS.$_SERVER['HTTP_HOST'].'.php';
} elseif ( count($_SERVER['argv']) ) { // cli
    $_SERVER['HTTP_HOST'] = $_SERVER['argv'][count($_SERVER['argv'])-1];
    $bootstrap = CONFIGS .'domains'.DS.$_SERVER['argv'][count($_SERVER['argv'])-1].'.php';
}
if ( file_exists($bootstrap) ) {
    require($bootstrap); 
} else {
    echo 'No configuration could be loaded for domain '.$_SERVER['HTTP_HOST'].'. Exiting...';
    exit;
}   


// At the bottom you can override configurations if you found you had to.
// This is also where you define defaults for constants. (keeps the if out of the domain file)
if ( !defined('CLIENT_NAME') ) {
    define('CLIENT_NAME', 'No Client');
}

</pre>




<h4>Domain files</h4>


<p>
In <b>app/config/</b> I create a folder called <b>domains</b>. In it, I keep each domain-specific configuration file named after each domain.
</p>


<pre class="prettyprint linenums" lang="">
client1.example.com.php
client2.example.com.php
client3.example.com.php
myapp.site.php  <-- my local dev setup also gets it's own file.
myapp.local.php  <-- someone elses local setup.
</pre>




<h4> client1.example.com.php</h4>


<pre class="prettyprint linenums" lang="php">
&lt;?php
// this file will mostly contain modifications of the defaults from bootstrap.php
Configure::write('Config.language', 'eng');
define('CLIENT_NAME', 'Client One');


// But this is important. I set the database setting here!
Configure::write('Database.config', array(
    'default' => array(
        'driver' => 'mysqli_ex',
        'persistent' => false,
        'host' => 'localhost',
        'port' => '',
        'login' => 'client1',
        'password' => 'client1',
        'database' => 'client1',
        'schema' => '',
        'prefix' => '',
        'encoding' => 'utf8'
    ),
    'test' => array(
        'driver' => 'mysqli_ex',
        'persistent' => false,
        'host' => 'localhost',
        'port' => '',
        'login' => 'testing',
        'password' => 'testing',
        'database' => 'probably not',
        'schema' => '',
        'prefix' => '',
        'encoding' => 'utf8'
    )
));

</pre>




<h4>Database settings</h4>


<p>
As you can see I set the database configuration in the domain file. I prefer this to having a long list of database settings in database.php or a second file for each domain in the domains folder. The database settings are loaded like this:
</p>




<pre class="prettyprint linenums" lang="php">
&lt;?php
class DATABASE_CONFIG {
    var $default = array(
        'driver' => 'mysqli_ex',
        'persistent' => false,
        'host' => 'localhost',
        'port' => '',
        'login' => 'root',
        'password' => '',
        'database' => 'default',
        'schema' => '',
        'prefix' => '',
        'encoding' => 'utf8'
    );

    function __construct () {       
        $config = Configure::read('Database.config');
        if ( !is_array($config) ) {
            // screaming exit here?
            return;
        }
        foreach ( $config as $name=>$data ) {
            $this->$name = $data;
        }
    }
    
}

</pre>




<p>
The database file dynamically creates the attributes (class-variables) from the keys in the domain-specific file. This is probably illegal php by some strict setting but I still sleep well at night. The reason I do this and not, like some other people, simply set the &#8220;default&#8221; to whatever I have in the domain-file (see links at the bottom) is that I sometimes need several databases accessible from the application. This way I can dynamically create as many as I like.
</p>


<h3>And there shall be a shell.</h3>

<p>
The shell access is always a problem. You have no server-environment available and no Cake-magic to fake it, as far as I know. The fix is simple but also the least robust part of this setup. Bootstrap is set to accept the domain as a shell argument. 
</p>


<h4>part of bootstrap.php again</h4>


<pre class="prettyprint linenums" lang="php">
&lt;?php

if ( isset($_SERVER['HTTP_HOST']) ) { // normal web access
    $bootstrap = CONFIGS .'domains'.DS.$_SERVER['HTTP_HOST'].'.php';
} elseif ( count($_SERVER['argv']) ) { // we need a cli agrument (argv will always exist so this is a bit pointless)
    $_SERVER['HTTP_HOST'] = $_SERVER['argv'][count($_SERVER['argv'])-1];
    $bootstrap = CONFIGS .'domains'.DS.$_SERVER['argv'][count($_SERVER['argv'])-1].'.php';
}


</pre>


<p>
These lines set the server name and the include file from the last shell argument. That is the less robust part and something you may wish to modify if you find it breaks your shells.
</p>


<br />


<p>
My hourly script is runs like this:
</p>


<pre class="prettyprint linenums" lang="">
/path/to/cake/cake/console/cake hourly client1.example.com
</pre>


<p>
And from cron that would be:
</p>


<pre class="prettyprint linenums" lang="">
/path/to/cake/cake/console/cake -app /path/to/cake/app/ hourly client1.example.com
</pre>


<p>
I have even verified that the HTTP_HOST survives a requestAction(), good old requesrtAction ;)
</p>


<h3>Anything to look out for?</h3>

<p>
This technique works. I have used a variation of this on a live application for almost 3 years. Before devising this tweaked and updated version I looked at the suggestions from blogs and posts around the web. For my purposes this is the best I have seen. But it is not without it&#8217;s potential problems.
</p>


<br />


<p>
Caching is not exhaustively tested. I can say that Cake&#8217;s default caching of models and &#8220;persistent&#8221; things are not adversely affected. Other caching, I don&#8217;t know. You can specify &#8220;domains&#8221; for cache files which would be a way to get around problems.
</p>


<br />


<p>
Logs will be jumbled together. I have so far had to patch the CakePHP core to achieve domain-specific logs. See update below.
</p>


<br />


<p>
Uploaded files should be pointed to domain-specific folders. You don&#8217;t want a file called trade-secrets.doc to be accessed by the wrong domain!
</p>


<h3>That&#8217;s it</h3>

<p>
Thanks for reading. If you are not bored yet below are a few blog posts that I used as inspiration and reference in varying amounts.
<br /><br />
<a href="http://rafaelbandeira3.wordpress.com/2008/12/05/handling-multiple-enviroments-on-cakephp/">http://rafaelbandeira3.wordpress.com/2008/12/05/handling-multiple-enviroments-on-cakephp/</a><br />
<a href="http://www.littlehart.net/atthekeyboard/2008/11/28/handling-multiple-environments-in-your-php-application/">http://www.littlehart.net/atthekeyboard/2008/11/28/handling-multiple-environments-in-your-php-application/</a><br />
<a href="http://edwardawebb.com/programming/php-programming/cakephp/automatically-choose-database-connections-cakephp">http://edwardawebb.com/programming/php-programming/cakephp/automatically-choose-database-connections-cakephp</a>
</p>


<br /><br />


<h3>Update: Hacking the core to redirect the tmp folder</h3>

<p>
I did a minimal patch to the CakePHP (via git, updates are very painless with simple patches).
</p>




<pre class="prettyprint linenums" lang="xml">
diff --git a/cake/config/paths.php b/cake/config/paths.php  
index 6a6449f..075313a 100644  
--- a/cake/config/paths.php  
+++ b/cake/config/paths.php  
@@ -46,6 +46,9 @@  
 if (!defined('APP')) {  
        define('APP', ROOT.DS.APP_DIR.DS);  
 }  
+if (file_exists(APP . 'config' . DS . 'paths.php')) {  
+       include_once APP . 'config' . DS . 'paths.php';  
+}  
 /**  
  * Path to the application's models directory.  
  */
</pre>




<p>
I then add the necessary file app/config/paths.php and put this into it:
</p>




<pre class="prettyprint linenums" lang="php">
if ( !isset($_SERVER['SERVER_NAME']) ) { 
    if ( count($_SERVER['argv']) ) { // cli 
        $_SERVER['SERVER_NAME'] = $_SERVER['argv'][count($_SERVER['argv'])-1]; 
    } else { 
        echo 'No server name is available. Halting...'; 
        exit; 
    } 
} 

$tmp = APP.'tmp'.DS .'domains'.DS.$_SERVER['SERVER_NAME'].DS; 
    //print_r($tmp); 
if ( !is_dir($tmp) ) { 
    $old = umask(0);     
    @mkdir($tmp,0777,true); 
    @mkdir($tmp.'logs'.DS,0777,true); 
    @mkdir($tmp.'cache'.DS.'models'.DS,0777,true); 
    @mkdir($tmp.'cache'.DS.'persistent'.DS,0777,true); 
    @mkdir($tmp.'cache'.DS.'views'.DS,0777,true); 
    @mkdir($tmp.'sessions'.DS,0777,true); 
    umask($old); 
    if ( is_dir($tmp) ) { 
        if (!defined('TMP')) { 
            define('TMP', $tmp); 
        } 
    } else { 
        echo 'Specific temporary folder does not exist: '.$tmp.' - Halting...'; // ROOT.DS.APP_DIR.DS 
        exit; 
    } 
} else { 
    if (!defined('TMP')) { 
        define('TMP', $tmp); 
    } 
}
</pre>




<p>
This code will check that a domain-tmp exists or try to create it if it does not. Finally it defines TMP. I have kept the permissions very loose in this example. I suggest tightening it up before going public.
</p>


<p>
I had to hack the core, but that puts me into deployment nirvana. One source-tree on the server while keeping separate logs, cache, uploads and anything else kept in tmp.
</p>


<p style="font-size:11px;">published @ <a href="http://bakery.cakephp.org/articles/view/one-core-one-app-multiple-domains">http://bakery.cakephp.org/articles/view/one-core-one-app-multiple-domains</a>
</p>

</div>

  


    <footer>
      <p class="meta">
        
  

<span class="byline author vcard">Posted by <span class="fn">Martin Westin</span></span>

        








  


<time datetime="2009-02-18T00:00:00+01:00" pubdate data-updated="true">Feb 18<span>th</span>, 2009</time>
        

<span class="categories">
  
    <a class='category' href='/blog/categories/articles/'>Articles</a>
  
</span>


      </p>
      
        <div class="sharing">
  <br/>
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://eimer.co/blog/2009/02/18/one-core-one-app-multiple-domains-for-cakephp/" data-via="eimer" data-counturl="http://eimer.co/blog/2009/02/18/one-core-one-app-multiple-domains-for-cakephp/" >Tweet</a>
  
  
  
</div>

      
      <p class="meta">
        
          <a class="basic-alignment pull-left" href="/blog/2009/02/02/finding-ordered-position-of-a-row-in-mysql/" title="Previous Post: Finding ordered position of a row in MySQL">&laquo; Finding ordered position of a row in MySQL</a>
        
        
          <a class="basic-alignment pull-right" href="/blog/2009/06/04/starschema-olap-setup-for-reporting-in-cakephp/" title="Next Post: StarSchema (OLAP) setup for reporting in CakePHP">StarSchema (OLAP) setup for reporting in CakePHP &raquo;</a>
        
      </p>
    </footer>

    
  </div>

  
    
  <div class="span4 sidebar">
    <div class="well">
      
        <section>
  <h4>Recent Posts</h4>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/17/shelling-out-from-a-ruby-app-to-a-ruby-app-without-bundler-conflicts/">Shelling out from a ruby app to a ruby app without bundler conflicts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/29/winning-two-gsma-global-mobile-awards/">Winning Two GSMA Global Mobile Awards</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/09/looping-through-large-and-slow-datasets-in-ruby/">Looping through large and slow datasets in Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/03/quick-tip-ios-and-web-graphics-in-illustrator/">Quick Tip: iOS and web graphics in Illustrator</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/07/26/patents-gone-crazy/">Patents Gone Crazy</a>
      </li>
    
  </ul>
</section>
<section>
  <h4>Categories</h4>
    <ul id="category-list"><li><a href='/blog/categories/articles'>Articles (8)</a></li><li><a href='/blog/categories/code'>Code (12)</a></li><li><a href='/blog/categories/general-interest'>General Interest (10)</a></li><li><a href='/blog/categories/milestones-in-music'>Milestones in Music (15)</a></li><li><a href='/blog/categories/the-pensive'>The Pensive (17)</a></li></ul>
</section>

<section>
  <h4>GitHub Repos</h4>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/eimermusic">@eimermusic</a> on GitHub
  
  <script type="text/javascript">
    $(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'eimermusic',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h4>Latest Tweets</h4>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  
    <a href="http://twitter.com/eimer" class="twitter-follow-button" data-show-count="false">Follow @eimer</a>
  
</section>


      
    </div>
  </div>


  
</div>


      </div>
    </div>
    <footer class="footer"><p>
  Copyright &copy; 2013 - Martin Westin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> -
</p>
</footer>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/js/prettify.js"></script>
<script>
  !function ($) {
    $(function(){
      window.prettyPrint && prettyPrint()
    })
  }(window.jQuery)
</script>








  </div>
</body>
</html>
