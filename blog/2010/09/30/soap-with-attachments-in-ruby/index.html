
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>SOAP with Attachments in Ruby - My New Home</title>
  <meta name="author" content="Martin Westin">

  
  <meta name="description" content="I found myself once again facing SOAP. This abomination of a protocol they even have the nerve to call &#8220;web services&#8221; is not my favorite &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://eimer.co/blog/2010/09/30/soap-with-attachments-in-ruby">
  <link href="/favicon.ico" rel="icon">

  <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/font-awesome/css/font-awesome.css" rel="stylesheet" type="text/css">

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

  <link href="/atom.xml" rel="alternate" title="My New Home" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11893308-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    data-spy="scroll">

  <div class="container">
    <header class="jumbotron subhead" id="overview">
      
<div class="subscribe">
  <table>
    <tr>
      <td><span>Get Updates: &nbsp;</span></td>
      
      
      <td><a href="/atom.xml" class="btn"><i class="icon-cog"></i> By RSS</a></td>
      
      
      <td><a href="http://twitter.com/eimer" class="btn"><i class="icon-twitter-sign"></i> On Twitter</a></td>
      
    </tr>
  </table>
</div>

<h1 class="title">My New Home</h1>

  <p class="lead">migrated from the 10 year-old eimermusic.com</p>


      <div class="navbar">
  <div class="navbar-inner">
    <div class="container" style="width: auto;">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <div class="nav-collapse">
                <ul class="nav">
          <li><a href="/">Home</a></li>
          <li><a href="/music">Music</a></li>
          <li><a href="/photos">Photos</a></li>
          <li><a href="/portfolio">Portfolio</a></li>
          <li><a href="/about">About</a></li>
        </ul>

        
          <form action="http://google.com/search" method="get" class="navbar-search pull-left">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:eimer.co" />
              <input type="text" name="q" results="0" placeholder="Search" class="search-query span2" />
            </fieldset>
          </form>
        
        
      </div><!-- /.nav-collapse -->
    </div>
  </div><!-- /navbar-inner -->
</div>

    </header>
    <div id="main">
      <div id="content">
        <div class="row">
  
  <div class="span8">
    
  <header>
    
      <h1 class="entry-title">SOAP With Attachments in Ruby</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-09-30T00:00:00+02:00" pubdate data-updated="true">Sep 30<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  
  
  <div class="entry-content"><p>I found myself once again facing SOAP. This abomination of a protocol they even have the nerve to call &#8220;web services&#8221; is not my favorite type of API to interface with (how did you guess?). I think probably the only language with any decent support is Java and possibly .net. Neither rank among my favorite languages either. Funny that.</p>

<p>My bigger problem is that the service I am interfacing with is noting as simple as sending an integer and getting an integer back. It requires that I post a multipart/mime SOAP message (aka SOAP with Attachments afaik). This is something that most SOAP libraries are not too keen on supporting.</p>

<h3>What are multipart SOAP messages?</h3>

<p>In short they are encoded a kind-of like email messages and their attachments but sent using http to a SOAP endpoint. The normal SOAP message becomes one of the mime parts and any other parts are called attachments and usually referenced from inside the SOAP message.</p>

<h3>A little history</h3>

<p>A few years ago in PHP I was stuck using NuSOAP and ended up basically bypassing most of NuSOAP and encoding the attachments and doing all that myself. The code was a real mess.</p>

<p>Last week I got to do it all over again. This time in Ruby. At work, we are porting our entire platform to Ruby, but detailing that process might be a post in itself. I was so happy when I found that soap4r has support for mime messages. Then I tried to use soap4r. Long story short. I liked it so much I chose to go with Savon instead&#8230; which has no mime support.</p>

<h3>What I ended up with</h3>

<p>The results of my efforts is not pretty by Ruby standards but a lot better than my old code in php. I patched Savon in two places. One to enable any namespace on the SOAP body (which is otherwise hard-coded to &#8220;wsdl&#8221;) and has little to do with mime messages.</p>

<p>The other place was to intercept the output and check if the SOAP object had any attachments (parts) added to it. If so, it will take the intended output and encode that as a mime part and then encode the other parts and put it all together as a nice big http packet ready for posting.</p>

<p>I think it best if I just show the code now.</p>

<script src="https://gist.github.com/602864.js?file=savon_mime_support_patch_example.rb"></script>


<p>Any questions posted to the gist or here will be adressed to the best of my abilities.</p>
</div>

  


    <footer>
      <p class="meta">
        
  

<span class="byline author vcard">Posted by <span class="fn">Martin Westin</span></span>

        








  


<time datetime="2010-09-30T00:00:00+02:00" pubdate data-updated="true">Sep 30<span>th</span>, 2010</time>
        


      </p>
      
        <div class="sharing">
  <br/>
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://eimer.co/blog/2010/09/30/soap-with-attachments-in-ruby/" data-via="eimer" data-counturl="http://eimer.co/blog/2010/09/30/soap-with-attachments-in-ruby/" >Tweet</a>
  
  
  
</div>

      
      <p class="meta">
        
          <a class="basic-alignment pull-left" href="/blog/2010/08/31/kanye-west-808s-heartbreak/" title="Previous Post: Kanye West - 808s & Heartbreak">&laquo; Kanye West - 808s & Heartbreak</a>
        
        
          <a class="basic-alignment pull-right" href="/blog/2010/10/30/offensively-lazy-web-developers/" title="Next Post: Offensively lazy web developers">Offensively lazy web developers &raquo;</a>
        
      </p>
    </footer>

    
  </div>

  
    
  <div class="span4 sidebar">
    <div class="well">
      
        <section>
  <h2>Recent Posts</h2>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/17/shelling-out-from-a-ruby-app-to-a-ruby-app-without-bundler-conflicts/">Shelling out from a ruby app to a ruby app without bundler conflicts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/29/winning-two-gsma-global-mobile-awards/">Winning Two GSMA Global Mobile Awards</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/09/looping-through-large-and-slow-datasets-in-ruby/">Looping through large and slow datasets in Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/03/quick-tip-ios-and-web-graphics-in-illustrator/">Quick Tip: iOS and web graphics in Illustrator</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/07/26/patents-gone-crazy/">Patents Gone Crazy</a>
      </li>
    
  </ul>
</section>

<section>
  <h2>GitHub Repos</h2>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/eimermusic">@eimermusic</a> on GitHub
  
  <script type="text/javascript">
    $(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'eimermusic',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h2>Latest Tweets</h2>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  
    <a href="http://twitter.com/eimer" class="twitter-follow-button" data-show-count="false">Follow @eimer</a>
  
</section>





      
    </div>
  </div>


  
</div>


      </div>
    </div>
    <footer class="footer"><p>
  Copyright &copy; 2013 - Martin Westin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> -
  
    <span class="credit">Theme by <a href="http://brianarmstrong.org">Brian Armstrong</a></span>
  
</p>
</footer>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>








  </div>
</body>
</html>
