
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My New Home</title>
  <meta name="author" content="Martin Westin">

  
  <meta name="description" content="This is slightly modified from something I found @ http://www.kirupa.com/forum/archive/index.php/t-263260.html Using high-score lists or similar you &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://eimer.co/blog/page/5">
  <link href="/favicon.ico" rel="icon">

  <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/font-awesome/css/font-awesome.css" rel="stylesheet" type="text/css">

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

  <link href="/atom.xml" rel="alternate" title="My New Home" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11893308-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    data-spy="scroll">

  <div class="container">
    <header class="jumbotron subhead" id="overview">
      
<div class="subscribe">
  <table>
    <tr>
      <td><span>Get Updates: &nbsp;</span></td>
      
      
      <td><a href="/atom.xml" class="btn"><i class="icon-cog"></i> By RSS</a></td>
      
      
      <td><a href="http://twitter.com/eimer" class="btn"><i class="icon-twitter-sign"></i> On Twitter</a></td>
      
    </tr>
  </table>
</div>

<h1 class="title">My New Home</h1>

  <p class="lead">migrated from the 10 year-old eimermusic.com</p>


      <div class="navbar">
  <div class="navbar-inner">
    <div class="container" style="width: auto;">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <div class="nav-collapse">
                <ul class="nav">
          <li><a href="/">Home</a></li>
          <li><a href="/music">Music</a></li>
          <li><a href="/photos">Photos</a></li>
          <li><a href="/portfolio">Portfolio</a></li>
          <li><a href="/about">About</a></li>
        </ul>

        
          <form action="http://google.com/search" method="get" class="navbar-search pull-left">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:eimer.co" />
              <input type="text" name="q" results="0" placeholder="Search" class="search-query span2" />
            </fieldset>
          </form>
        
        
      </div><!-- /.nav-collapse -->
    </div>
  </div><!-- /navbar-inner -->
</div>

    </header>
    <div id="main">
      <div id="content">
        <div class="row">
  
  <div class="span8 blog-index">
    
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/02/finding-ordered-position-of-a-row-in-mysql/">Finding Ordered Position of a Row in MySQL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-02T00:00:00+01:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is slightly modified from something I found @ <a href="http://www.kirupa.com/forum/archive/index.php/t-263260.html">http://www.kirupa.com/forum/archive/index.php/t-263260.html</a></p>

<p>Using high-score lists or similar you often have a large number of rows where you want to know who is in 7th place or how well is id:254 doing.
This eliminates the slow looping in php of big result-sets by making a sub-query in MySQL.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
SET @rownum := 0;

SELECT * FROM (
SELECT @rownum := @rownum+1 AS rank, id, points
FROM highscores 
ORDER BY points DESC
) AS highscores WHERE id = 254;
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/01/18/http-basic-authentication-in-cakephp-with-users-from-database/">HTTP Basic Authentication in CakePHP With Users From Database</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-01-18T00:00:00+01:00" pubdate data-updated="true">Jan 18<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
This is a few lines of code and explanations explaining how to get HTTP Auth to check against your normal users table.
</p>


<br />


<p>
Intended audience:<br />
• You want to provide a protected RSS feed.<br />
• You want to provide a protected API.<br />
</p>


<br />


<p>
Prerequisites: <br />
• You should be familiar with the basics of the Security and Auth Comoponents.<br />
• You should be aware that this technique does have a slightly lower level of security than your normal logins.<br />
• Your application already has some form of authentication setup.<br />
• I will asume you are using Auth Component in your App Controller in the example.
</p>


<br />


<p>
The Cookbook does a good job of explaining how to setup simple protection for a controller or action using HTTP basic authentication. In these examples the usernames and passwords are all hard-coded. Setting things up so that the authentication uses your normal user-data (e.g. from a database) is pretty simple but not extensively documented.
</p>


<br />


<p>
Here is all the relevant code.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
class MyController extends AppController {

    var $components = array('Security','RequestHandler');
    
    function beforeFilter() { 
        if ( $this->RequestHandler->isRss() ) { 
            $this->Auth->allow('index'); 
            $this->Security->loginOptions = array( 
                'type'=>'basic', 
                'login'=>'authenticate', 
                'realm'=>'MyRealm' 
            ); 
            $this->Security->loginUsers = array(); 
            $this->Security->requireLogin('index'); 
        } 
        parent::beforeFilter(); 
    } 
    
    function authenticate($args) { 
        $data[ $this->Auth->fields['username'] ] = $args['username']; 
        $data[ $this->Auth->fields['password'] ] = $this->Auth->password($args['password']); 
        if ( $this->Auth->login($data) ) { 
            return true; 
        } else { 
            $this->Security->blackHole($this, 'login'); 
            return false; 
        } 
    } 

    function index() {
        // this is a protected function now
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h3>A quick walkthrough</h3>

<p>
I will asume that authentication is setup globally in AppController. Naturally it is necessary to include the relevant components. 
</p>




<h4>beforeFilter</h4>


<ul>
<li>
First I check if the request is for the RSS feed. (If not the action authenticates like any other and renders a html view.)
</li>
<li>
Normal Authentication is disabled
</li>
<li>
loginOptions has set the &#8220;login&#8221; key containing the name of the method we want to handle authentication.
</li>
<li>
Then loginUsers is left blank (they wont be used), and login is required for the index action.
</li>
</ul>


<h4>authenticate</h4>


<ul>
<li>
$args contains the username and password. They are placed into a new array using the keys set for Auth.
</li>
<li>
Auth tries to login. if the login fails the request is actively &#8220;blackHoled&#8221;.
</li>
<li>
Returning true of false is just for show. It is ignored by Security component
</li>
</ul>




<br />


<p>
This is all that is needed to get started. It is not the safest authenticaiton in the world but using SSL alongside this technique will provide pretty good security for your API access.
</p>


<p style="font-size:11px;">published @ <a href="http://bakery.cakephp.org/articles/view/http-basic-authentication-with-users-from-database">http://bakery.cakephp.org/articles/view/http-basic-authentication-with-users-from-database</a>
</p>

</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/11/04/migrating-a-real-world-application-from-cakephp-1-1-to-1-2/">Migrating a Real-world Application From CakePHP 1.1 to 1.2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-11-04T00:00:00+01:00" pubdate data-updated="true">Nov 4<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
I thought I&#8217;d chronicle my work migrating my fist CakePHP application to CakePHP 1.2 (rc3 at the time of writing). The application was originally written for CakePHP 1.0 (= the good old days). It has been updated to work with the latest versions 1.1 but has not really been rewritten much. 
</p>


<p>
Considering how much CakePHP has evolved and also how many beginner-mistakes I have put into this application, this migration will also describe some pretty huge optimizations that was possible because of new features and my improved knowledge of CakePHP.
</p>


<h3>About The Application</h3>

<p>
The application if called Fileshifter and it is a simple file manager and file sharing application. The original purpose was to complement an ftp server. Fileshifter is generally more simple to manage and easier for &#8220;average people&#8221; to handle. You have projects and upload files into them or download files from them. As admin you can manage user accounts and project permissions.
</p>


<p>
The English pages on the application-website are horribly out of date. Sorry. There are a few screen-casts in the Swedish section that might give some context to what I am writing about, though.
</p>


<p><a href="http://www.fileshifter.se/">http://www.fileshifter.se/</a>
</p>


<h3>First attempt. Aka: Oh crap, nothing works</h3>

<p>Just dropping my old application into CakePHP 1.2 clearly didn&#8217;t work. :)
I just got two errors. The second one was a fatal error which halted further execution in config/routes.php
</p>


<p>I went through all files in the config directory. This took a little while but I wanted to get the configurations identical to those I had before. One bonus for my application is the new configuration directive to not check the userAgent. This will be very useful for my upload actions that will be used by the java applet the application uses. In earlier versions I manually hacked the core to make this possible.
</p>


<h4>core.php</h4>


<p>Starting with a clean file from CakePHP 1.2 I changed the following things for my application. Not all as strictly necessary to get an application running.
</p>


<ul>
<li><strong>Session.cookie</strong> - set to the same name as in the old application.</li>
<li><strong>Session.checkAgent</strong> - set to false globally for the time being. I will check if I can set this just in the relevant controller without causing problems.</li>
<li><strong>Security.salt</strong> - should always be altered. I kept part of the original string, moved things around and inserted some swedish words here and there just for fun.</li>
</ul>




<h4>bootstrap.php</h4>


<p>My old file set a few constants used to configure the application. A few of these I switched over to the new Configure class. Most, I left as constants since they are nothing you would ever change at runtime. For example the path to the root of the file area.<br/>
The current language was one of the ones I switched over. See below about i18n.
</p>


<h4>database.php</h4>


<p>Not a big problem here. The could have been left as is but I did copy over the login parameters to a fresh file. I noticed that the connect parameter does not need to be set for MySQL. I am not sure about before but now it is enough to set persistent to true.
</p>


<h4>routes.php</h4>


<p>The few routes I had defined only needed to call the method statically to continue to work. For example:</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$Route->connect ('/', array('controller'=>'efs', 'action'=>'index'));
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>became:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
Router::connect('/', array('controller' => 'efs', 'action' => 'index'));
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>I also replaced all default files (index.php, .htaccess &#8230;). I did not bother to check which had changed. It was simpler to just replace them all with the new 1.2 versions.
</p>


<h3>File model clashes with the File class</h3>

<p>Since my application is a file manager I had a model called File. It actually took me a good while before I figured out that my File model clashes with the File class in the core. Time for some search and replace. All references to File was replaced with EfsFile (did not think of anything better). Most of it could be changed this simply, but I had to make a few manual adjustments. Cakes $useTable came in good use here. I did not have to alter the database just because I renamed the class.
</p>


<h3>Replacing authentication</h3>

<p>Next big problem is authentication. Since all data the user can interact with flows from the authenticated user account, this basically stops my application completely until I get the new authentication up and running. Lucky enough I was using an Auth component that works kind-of similar to the current Auth component in the core. There was still a lot of work but it could have been worse.
</p>


<p>I didn&#8217;t keep any of the code from the old authentication. What I did was take copy a lot of it over from another application where I first tried some basic 1.2 authentication. The code is pretty much straight out of the tutorials available all over the web.
</p>


<h3>Permissions</h3>

<p>In the original version I intentionally kept permissions to a minimum. Simplicity was the key and increased complexity and granularity in permissions will increase the workload for the administrator. This was of-course no bad thing when it came to updating the authentication. The old Component used a User model and a Permission model. I saw no reason to even have a model for permissions anymore since all I needed was &#8220;normal user&#8221; and &#8220;admin user&#8221;. I mapped this to a simple integer field in the users table. I can imagine that trying to migrate a role-based system can be a lot more work.
</p>


<h3>Transitioning old passwords</h3>

<p>I have managed to keep all the old passwords. They were md5 hashed without a salt so I was able to get it working by defining an authenticate object for Auth. I chose to make the User model the authenticate object. It feels natural to have password hashing there.
</p>


<p>In AppController::beforeFilter:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$this->Auth->authenticate =& $this->Auth->getModel();
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>And in models/user.php I added:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
function hashPasswords($data) {
    if (is_array($data) && isset($data[$this->alias])) {
        if (isset($data[$this->alias]['email']) && isset($data[$this->alias]['pass'])) {
            $data[$this->alias]['pass'] = Security::hash($data[$this->alias]['pass'], 'md5', false);
        }
    }
    return $data;
}
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>One thing still on the todo-list is that I would rather try to manage a transitional system for the first release after this migration. Something where the password can be checked against both the old and new hash. Any login where the stored password matches the old hash will be replaced by the given password hashed using the new (more secure) system using a salt. If I can&#8217;t get that to work I have to make a judgement call wether to keep the old less safe passwords or require all users in all installations to renew their passwords. We&#8217;ll see&#8230;
</p>


<h3>Changing the code convention of the entire application</h3>

<p>This can be tedious if you plan to do it in one big pass. I decided to use this as an indicator of what code I had looked over and changed. Any method I altered or examined and decided not to alter was given a change in coding style to indicate that it was &#8220;approved&#8221; 1.2 code. If I had been happy with my old style I would not have done this, but since I planed to change it, this was a good way to do it.
</p>


<h3>Loading classes and other external code</h3>

<p>All the old methods of loading files have changed. No more uses(), no more vendor(). This is now all taken care of by App::import(). For example when I load a PEAR class to archive a whole folder:
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
vendor('Archive/Tar');
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>now reads:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
App::import('Vendor','Archive/Tar');
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>The component dealing with syncing with the filesystem nor loads the needed models in a single call, like this:</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
App::import('Model',array('Project','EfsFile'));
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h3>Removing requestAction()</h3>

<p>Like so many starting out, I was seduced by requestAction(). Looking at my old code I remember believing that only the UsersController should manipulate the User model. That is partly why I turned to requestAction when one controller needed access to &#8220;another model&#8221;.
</p>


<p>My primary requestAction() was to call &#8220;/files/viewedBy/1/1&#8221; whenever a user selected a new file. This would log that the user has seen the file. By moving this code into the EfsFile model I was abel to take the request-time for these down quite a bit. With my test-data this went down to 0.15s from well over a second before. Partly because of the overhead of a request and partly because of Containable helping to optimize the data retrieval.
</p>


<h3>Hey, where did my data go?</h3>

<p>One new behavior introduced in CakePHP 1.2 RC3 may delete some data by accident. If an association has conditions, you should use the new array notation for conditions. If you delete a record and dependent is true, you expect the related record(s) to be deleted as well. If conditions is not an array you can delete delete all records of the related model, not just related ones. I have had this happen to my data for hasOne associations. I have not done extensive test to see if this affects other associations.
</p>


<p>This is straight out of manual as it was a while ago:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
class User extends AppModel {
    var $name = 'User';
    var $hasMany = array(
        'Comment' => array(
            'className' => 'Comment',
            'foreignKey' => 'user_id',
            'conditions' => 'Comment.status = 1',
            'order' => 'Comment.created DESC',
            'limit' => '5',
            'dependent'=> true
        )
    );
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>And this is the small but important change:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
class User extends AppModel {
    var $name = 'User';
    var $hasMany = array(
        'Comment' => array(
            'className' => 'Comment',
            'foreignKey' => 'user_id',
            'conditions' => array('Comment.status' => '1'),
            'order' => 'Comment.created DESC',
            'limit' => '5',
            'dependent'=> true
        )
    );
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>I believe even empty conditions can cause you problems:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
'conditions' => '',
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>it should be:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
'conditions' => array(),
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>I am not certain about that last bit but better safe than sorry, right?</p>

<h3>Hey, where did my data go? part 2</h3>

<p>There was a bug introduced in CakePHP 1.2 rc3 that anyone updating should be aware of. Cake can accidentally delete data in the join tables of your HABTM associations. This happens if the association is two-sided and you remove the &#8220;link&#8221; between two records. Any other record the associated record is linked to is also unlinked. I found this out the hard way. I then discovered a bug report in trac. The fix described there has worked for me in two applications for a few weeks now. See the ticket for details and example-code.
</p>


<p><a href="https://trac.cakephp.org/ticket/5579">https://trac.cakephp.org/ticket/5579</a></p>

<h3>Finding new data</h3>

<p>The Model methods find(), findAll() and so on have changed a lot. This required a lot of manual work, but since I could optimize thing at the same time and speed up the application noticeably I didn&#8217;t really mind the work. I also thing this new syntax is a lot easier to use.</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$allProj = $this->Project->findAll(null,null,'Project.title ASC');
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>should now read:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$allProj = $this->Project->find('all',array(
    'order' => 'Project.title ASC'
));
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>or better yet:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$allProj = $this->Project->find('all',array(
    'order' => array('Project.title' => 'ASC')
));
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p><em>Note: Keeping &#8220;ASC&#8221; in my example is not necessary but I like to have it there so I know at a glance what is going on.</em></p>

<p>OK, all find operations are now taken care of by find. The first parameter indicates the type of find to perform. Setting it to &#8220;first&#8221; will find a single record for example. The second parameter is an array, like in so many places in CakePHP 1.2. This should contain the additions you want to make to the query. As you can see order is one thing. Conditions is another. Fields is a third. I could never remember if order was parameter number 3,4 or 5. Now I don&#8217;t have to. I just add a key called order and a value with the ordering field and direction I want. It does not have to come before or after the conditions&#8230; all very nice.
</p>


<p>All of these parameters can be broken down into arrays themselves. This adds another layer of protection against sql injections. The conditions can even be broken down into ands and ors in a deep structure. Cake will construct a nice where-clause of them for you and keep track of all the parenthesis. See the manual for many examples of this. The same goes for deleteAll() and any other conditions throughout the application.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$result = $this->deleteAll( array(
    $this->alias.'.created <' => $deadline
));
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>Notice that the comparison operator is on the left side. This is new since CakePHP 1.2 RC2, I think.</p>

<h3>I can hardly contain myself</h3>

<p>Am am bursting with joy! Containable behavior is one of my favorite features in CakePHP 1.2. Containable is like find() on steroids.  It is like associations on acid. It is like&#8230; ok enough! The basic first step is to simple add this to the relevant models.</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
var $actsAs = array('Containable');
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>Containable is a behavior that helps you optimize your queries. Perviously all I could do was to set recursive and unbind a model. Containable sort-of does this for you, in a very intuitive way. Parts of the application has been sped up by a factor of 8. That is 8x the original request time, largely because of Containable.
<br />
It may sound like magic, but imagine this:<br />
<br />
<strong>User:</strong> habtm Project, habtm File<br />
<strong>Project:</strong> hasMany File, habtm User<br />
<strong>File:</strong> habtm User, belongsTo Project<br />
<br />
These three models can easily cause a lot of unnecessary data to be loaded since they relate to each-other in several ways. By taking advantage of some simple functionality in containable I was abel to eliminate most of the unused data from my queries. For example, loading a single file:
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$data = $this->User->find('first', array(
    'conditions' => array('User.id'=>$this->userData['User']['id']),
    'contain' => array(
        'Project'=>array(
            'EfsFile'=>array(
                'conditions'=>array('EfsFile.id'=>$this->params['id'])
            )
        )
    )
));
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>In english: Find the currently logged in User. Contain the results to also include any related Project and to the project related File if the id of the file is the one we want.</p>




<p>This may look like a backwards way of loading a file. However this is quite effective since I only want the file to load is it is in a project that the current user has access to. Using the Set class (another great new feature in 1.2) it is no big problem picking out the file from the results. Just imagine the mess returned if I had set recursive to 2 instead&#8230; I would have loaded all files in all projects related to the user and I would have had to loop through the results to locate the one with the right id (making it a condition would not have worked). OK, that was an example from hell but I hope the point was made. Containable is your friend. Please check the manual for more complete details on how to use Containable.
</p>


<h3>New validation system</h3>

<p>I must admit, I did not have a lot of validation before. The validation I had was mostly custom validation code. Some of it even in the controller (ick!). One thing I did validate before was, naturally, login data. For example, validating uniqueness is a lot better in 1.2. And there is also support for multiple validation rules per field. Apart from changing the validation I had I also added a few rules for the files and projects. I still have to change my controller code to make better use of the validation errors and messages, though.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
var $validate = array(
    'name'=>VALID_NOT_EMPTY,
    'login'=>VALID_NOT_EMPTY,
    'email'=>VALID_EMAIL
);
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>now reads:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
var $validate = array(
    'name' => array(
        'rule' => 'notEmpty',
        'message' => 'The name can not be left blank'
    ),
    'email' => array(
        'email' => array(
            'rule' => 'email',
            'message' => 'This is not a valid email.'
        ),
        'unique' => array(
            'rule' => 'isUnique',
            'message' => 'This email already used for another user.'
        )
    )
);
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>The error messages above have been replaced to make them more readable. They are in the form of translation keys in the real code.</p>

<h3>Synchronizing with the filesystem</h3>

<p>The application keeps its files and folders in the database. To enable admins to expose the files on their local network or a traditional ftp, there is a component that checks the filesystem for changes. I was able to optimize this comparison quite a bit. 
</p>


<p>My original code fetched all files and folders, queried the database and then compared the two using foreach loops. These become exponentially slower as the number of files grow. Comparing 100 files would result in 100*100 comparisons just to determine that nothing new has been added.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
foreach ( $system as $sysFile ) {
    foreach ( $data as $dataFile ) {
        if ( $sysFile['EfsFile']['filename'] == $dataFile['EfsFile']['filename'] ) {
            // OK, this file exists already
        }
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>The goal was to remove at least one of the foreach loops to keep the speed increase in check. Since these are Cake-style multi-dimensional arrays simple comparisons like array_diff() don&#8217;t work. The Set class was of-course a little slower than the foreach loops since it does basically the same thing, only a bit more advanced. 
</p>


<p>Once again I found that putting more responsibility on MySQL was the answer. My new code fetches all files and folders, loops through that data and queries the database to see if a known file can be found. Testing with about 3&#8217;000 files, I measured this code to be twice as fast as the original code. Checking 3&#8217;000 files in 14 folders now takes 4.5sec instead of 8.6sec.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
foreach ( $system as $sysFile ) {
    $this->EfsFile->contain();
    $found = $this->EfsFile->find('first', array(
        'conditions' => array(
            'EfsFile.filename'=> $sysFile['filename'],
            'EfsFile.project_id'=> $current_project_id
        )
    ));
    if ( $found ) {
        // OK, this file exists already
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h3>Filesystem case sensitivity</h3>

<p>I got this strange error while testing. Each sync with the filesystem would result in duplicate files in a certain project. Turned out the problem was one of case sensitivity. Some filesystems are case sensitive, some are not. PHP definitely is case sensitive when doing simple comparisons like $filename1 == $filename2. This can cause problems when files and folders are added and renamed outside of my application. Renaming a folder test => Test will still find the same folder when on a case insensitive system but it will not be considered the same folder by the sync code discussed above. I needed a way to handle this problem. Here is what I came up with:
</p>


<p>in config/bootstrap.php</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
define('EFS_FILESYSTEM_TYPE', 'ci'); // filesystem is set to case insensitive
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>in vendors/basics.php (my file of small handy global functions)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
// returns a filename or foldername in the correct case for comparison
function file_case($str) {
    if ( EFS_FILESYSTEM_TYPE == 'ci' ) {
        return low($str); // Filesystem in case insensitive
    } else {
        return $str; // Filesystem in case sensitive
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>That is ok and it works. But how many of my customers actually know what filesystem they are running? These are people who choose this app for its simplicity. Can&#8217;t I use some function to find the filesystem type automatically? Well, yes I can. I looked for some internal php mechanism but found none. There may be plenty of smarter ways to do this but here is what I did:
in vendors/basics.php (my file of small handy global functions)
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
// returns a filename or foldername in the correct case for comparison
function file_case($str) {
    if ( !defined('EFS_FILESYSTEM_TYPE') ) {
        if ( is_file(strtoupper(__FILE__)) ) {
            define('EFS_FILESYSTEM_TYPE', 'ci'); // Filesystem in case insensitive
        } else {
            define('EFS_FILESYSTEM_TYPE', 'cs'); // Filesystem in case sensitive
        }
    }
    
    if ( EFS_FILESYSTEM_TYPE == 'ci' ) {
        return strtolower($str); // Filesystem in case insensitive
    } else {
        return $str; // Filesystem in case sensitive
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>I checks &#8220;the same file&#8221; twise. Once with the filename capitalized and once in all lowercase. If they both exist then the filesystem should be case insensitive. This works when tested on HFS+ volumes of both types.
</p>


<h3>Re-factoring stupid noob code</h3>

<p>A post on the CakePHP Google group got me thinking about a component I coded for this application. It is (or was) a Ticket component for maintaining temporary tickets of the type many websites use for password resets and registration activations.
</p>


<p></p>When I started looking at this old component I realized that the only reason this was a component at all was vanity. I thought a component would be &#8220;kewl&#8221; and really wanted to create a component. This was of-course horribly wrong. The component may still be published here:
</p>
<a href="http://bakery.cakephp.org/articles/view/ticket-component-resetting-user-passwords">http://bakery.cakephp.org/articles/view/ticket-component-resetting-user-passwords</a></p>

<p>The component is really just a proxy to the Ticket model storing the tickets. I re-factored the code in the component into the model and included the model in the controllers that previously included the component.
</p>


<p>Unfortunately I had to rename most of the methods from the component since they clashed with internal Model methods like set() and del(). What took the most time was finding new names for these methods. Out of frustration I (temporarily) just called them setTicket() and drop(). Ugly, yes. I hate putting the class name in the method name&#8230; totally useless but my English vocabulary doesn&#8217;t include a good synonym.
</p>


<h3>l10n and i18n</h3>

<p>The original application used my own code for language management. I had a php-file for each language. All labels were defined in an associative array in those files. Like this:
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$labels = array();

//--  login page
$labels['login_username']  = 'Login Id';
$labels['login_password']  = 'Password';
$labels['login_login']     = 'Login';
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>The first step was to convert these files into gettext po-files. It was a matter of search and replace for 90% of it. Some comments had to be moved and changed manually and things of this nature. The results looked something like this:
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
# login page
msgid "login_username"
msgstr "Login Id"

msgid "login_password"
msgstr "Password"

msgid "login_login"
msgstr "Login"
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>These files were put into the relevant folders. E.g. locale/eng/LC_MESSAGES/default.po</p>

<p>The second step was to replace my own translation function with the built-in __(). I have never used that function directly. This is mainly since I prefer to have my strings returned and not output. I put a proxy function into my bootstrap which alters the default of the second argument.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
function ___($singular, $return = true) {
    return __($singular, $return);
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>I managed to change all the calls to $lang->show(&#8216;some_string&#8217;) to ___(&#8216;some_string&#8217;) in one glorious find and replace. That&#8217;s my kind of migration.
</p>


<p>The third and final change was to alter the language switching. I kept this in my bootstrap and only change it to write the configuration for the selected language. The old code is the commented lines. I kept the rest of my old code. As you can see it still uses cookies and it works just as well as before.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
if (isset($_COOKIE['EFS_LANG'])) {
    //define('EFS_LANG', $_COOKIE['EFS_LANG']);
    Configure::write('Config.language', $_COOKIE['EFS_LANG']);
} else {
    //define('EFS_LANG', 'sv');
    Configure::write('Config.language', 'sv');
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h3>Changing all view-files to use .ctp extension</h3>

<p>This takes all of 5 minutes and has absolutely no effect on the functionality of the application. It just feels better and considering the work involved why not? I just ran everything in the views folder through a filename changer (NameChanger for Mac OS X) and I was done.
</p>


<h3>Changes to form and html helpers</h3>

<p>Any previous call to html helper to generate a form element needs to be switched over to use the form helper. This did not affect my application much. Most html did not make use of either helper. I remember feeling it was less intuitive to make php calls to generate html instead of just writing the html directly. The application does not have a lot of forms either.
</p>


<p>With the login form as an example here is some of the things to look out for in views.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
<label for="UserLogin"><?php echo $lang->show('login_username'); ?></label>
<?php
$html->input('User/login',array(
    'style'=>"width:150px;"
));
?>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>now reads:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$form->input('User.email',array(
    'label'=>___('login_username'), 
    'div' => false, 
    'style'=>'width:150px;'
));
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>This is one area where the new helpers really shine. Just setting the label property IS simpler than writing the whole tag manually. since my layout did not have divs before I simply set that key to false to avoid the default div around my text field.
</p>


<p>Also notice that $html is replaced by $form and that the reference to the model field uses the new dot-notation. 
</p>


<p>I also switched to email logins, but that has nothing to do with the migration. I started out using usernames. When I created the feature to reset passwords a valid email address was necessary and the last big update changed to prefer email logins but still allowed old usernames during a transitional period. This version will deprecate the old logins once and for all.
</p>


<h3>Don&#8217;t render your elements</h3>

<p>Don&#8217;t get me wrong. Keep on using your elements. It is just the name of the method has changed from renderElement() to just element(). The application was full of these but this was another one of those things that a quick find and replace could solve in minutes. I did not find any problems afterwards. The parameters appear to work the same. 
</p>


<h3>Cleaning up my urls</h3>

<p>Besides cleaning up some of my mess in config/routes.php I did some spring-cleaning of the urls  in my views and controllers. This is not strictly necessary but it may come in handy if, or when, I want to create some new custom routes. Changing all urls to arrays instead of simple strings does look like a lot of complexity with little benefit.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
'/users/edit'
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>becomes:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
array('controller'=>'users', 'action'=>'edit')
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>Clearly harder to read, right? The benefit is that I can now decide to create an &#8220;alias&#8221; in routes.php so that links to /profile should go to the edit action of the users controller. As if by magic, all links and redirects to that editing screen will change from /users/edit to /profile. Cool!
</p>


<p>Another little nice (new?) feature I found was for the classic &#8220;logo links back to start-page&#8221;. Every website in the world has this and it can be done very nicely. This mess:
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
<a href="<?php echo $html->url('/'); ?>"><?php echo $html->image('fileshifter_logo_bar.gif',array('alt'=>'Fileshifter logo'))?></a>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>could be written like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
<?php echo $html->image('fileshifter_logo_bar.gif',array('alt'=>'Fileshifter logo', 'url'=>'/')); ?>
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>The image method accepts an url parameter and creates a link around the image for you. It does look nice and clean. If you need some attributes set for the link you can also use the link method and just put a call to the image method where the &#8220;text label&#8221; for the link is set. See the manual, it has a clear example of it. It is a lot simpler than I make it sound.
</p>


<h3>Consolidating layouts and views.</h3>

<p>Some of my old view code was duplicated because I did not know all the tricks back then. For example, my layouts (three of them) were almost identical but they has a few things that set them apart.
</p>


<p>Since data for the current user is always available to the view, one simple fix was to add an if-clause that would output the correct menu-items  for each situation.
</p>


<p>The other problem I had was that $content_for_layout had to be wrapped and accompanied by different code for different sections of the application. The fix is simple but not one I knew about two years ago. I made a common base-layout:
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
--base.ctp--
...lots of html for menu and header...

<?php echo $content_for_layout; ?>

...some more html for the footer...
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>And then I created two other layouts of this kind (this is the most simple one):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
--default.ctp--
<?php
echo $this->renderLayout('<div id="container">'.$content_for_layout.'</div>','base');
?>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>This layout simply wraps the content in a container div and passes it along to the base layout. The other layout had a lot more html around the content but that would be less clear to display like this.
</p>


<h3>Onwards and upwards</h3>

<p>Those were the steps I took to migrate and improve my application this time around. Not all of them are necessary but all of them help the application improve and conform to new conventions. For example, old string conditions still work but using the new array notation lets Cake protect you from SQL injection, makes it easier to modify conditions in behaviors and beforeFind() and other advantages big and small.
</p>


<p>If you find that any aspect of the migration is lacking in detail or plain missing, please don&#8217;t hesitate to drop me a line in the comments. Hopefully I will be able to cover such requests in future updates.
</p>




<p style="font-size:11px;">published @ <a href="http://bakery.cakephp.org/articles/view/migrating-a-real-world-application-to-cakephp-1-2">http://bakery.cakephp.org/articles/view/migrating-a-real-world-application-to-cakephp-1-2</a>
</p>

</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/08/duplicating-a-mysql-database/">Duplicating a Mysql Database</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-08T00:00:00+02:00" pubdate data-updated="true">Oct 8<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is another MySQL trick I keep coming back to.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:bash </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
mysqldump -u root --password=pass db1 | mysql -u root --password=pass db2
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>found @ http://mywheel.net/blog/index.php/2006/01/05/mysql-duplicate-database-quick-tip/</p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/07/locating-potential-duplicate-before-switching-collation-in-mysql/">Locating Potential Duplicate Before Switching Collation in MySQL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-07T00:00:00+02:00" pubdate data-updated="true">Oct 7<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When you need to switch a fields collation you can check if any existing data will conflict with this change.</p>

<p>For example a keyword-field might contain data that is considered unique in one collation but not in another. The Swedish character ä is considered a unique character in swedish collation but in general collation it is only an a in an accented form.</p>

<p>Comparing the results from these two queries will show what effect, if any, an change in collation will have.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
SELECT id, keyword as key, count(*) as num FROM keywords GROUP BY key having num > 1;
SELECT id, keyword COLLATE utf8_unicode_ci as key, count(*) as num FROM keywords GROUP BY key having num > 1;
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/10/06/copy-files-while-preserving-permissions/">Copy Files While Preserving Permissions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-10-06T00:00:00+02:00" pubdate data-updated="true">Oct 6<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The unix cp command makes you the owner of the copied files. You can set flags but this is supposedly a more complete way to keep any attributes.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang: </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
mkdir /var/backup/michael
cd /home/michael
tar cf - . | (cd /var/backup/michael && tar xBfp -)
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>found @
<a href="http://info.michael-simons.eu/2007/03/18/copy-directories-and-preserve-permissions/">http://info.michael-simons.eu/2007/03/18/copy-directories-and-preserve-permissions/</a></p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/31/inserting-from-a-select-in-mysql/">Inserting From a Select in MySQL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-31T00:00:00+02:00" pubdate data-updated="true">Aug 31<span>st</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Quite simple but something I can never seem to remember:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
INSERT INTO files_users (file_id, user_id) 
SELECT id, '2' FROM efs.files;
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>found @ <a href="http://mysql-tips.blogspot.com/2005/04/mysql-insert-select-example.html">http://mysql-tips.blogspot.com/2005/04/mysql-insert-select-example.html</a></p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/06/24/replacing-characters-in-mysql-table-data/">Replacing Characters in MySQL Table Data</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-06-24T00:00:00+02:00" pubdate data-updated="true">Jun 24<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This may be useful when for example the character encoding has been messed up and you need to correct existing data.</p>

<p>This example will correct swedish accented characters in a uft8 - latin1 mixup.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
UPDATE my_table
set my_field = replace(my_field,'Ã¥','å');

UPDATE my_table
set my_field = replace(my_field,'Ã¤','ä');

UPDATE my_table
set my_field = replace(my_field,'Ã¶','ö');


UPDATE my_table
set my_field = replace(my_field,'Ã…','Å');

UPDATE my_table
set my_field = replace(my_field,'Ã„','Ä');

UPDATE my_table
set my_field = replace(my_field,'Ã–','Ö');
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>(Yes, you can concatenate them if you like but they become very hard to read.)</p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/06/24/preferred-character-set-and-collation-in-mysql/">Preferred Character Set and Collation in MySQL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-06-24T00:00:00+02:00" pubdate data-updated="true">Jun 24<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>My preferred character set is utf8.
One big drawback in many cases can be that the default collation ignores accents for characters. The result is that &#8220;halla&#8221; and &#8220;hallå&#8221; is interpreted as the same word. This is of-course bad for storing general data such as names users or products that may very well have accented characters that should be respected.</p>

<p>The sollution for me is to not use &#8220;utf8_general_ci&#8221;.</p>

<p>For generic data that have no particular language I prefer &#8220;utf8_bin&#8221;
For data that will be sorted and that can be given a &#8220;language&#8221; I prefer the collation most appropriate, such as &#8220;utf8_swedish_ci&#8221;</p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/06/24/fixing-existing-data-when-switching-character-set-in-mysql/">Fixing Existing Data When Switching Character Set in MySQL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-06-24T00:00:00+02:00" pubdate data-updated="true">Jun 24<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When altering a database, table or field from one character set to another, existing data will probably look garbled since it is expected to be in the new character set. To &#8220;convert&#8221; existing data is not always easy. This method (found in the comments of a blog entry I have lost the url for) works as long as you can keep the database &#8220;locked&#8221; when you do this. Otherwise you will convert any new data entered and make that data look garbled.</p>

<p>If your content is latin1 but should be read as utf8 you would do the following to convert existing data.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
ALTER TABLE my_table CHANGE my_field my_field TEXT CHARACTER SET latin1;

ALTER TABLE my_table CHANGE my_field my_field BLOB;

ALTER TABLE my_table CHANGE my_field my_field TEXT CHARACTER SET utf8;
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>The important bit is the use of the BLOB datatype. Since it is a binary datatype it has no character set. The datatype you start and end with can be any char, varchar, text or similar datatype.</p>

<p>A full test case to play with:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
# case where data was enterd correctly as latin1 and later needs conversion to utf8

SET NAMES latin1;

drop table people;

CREATE TABLE people (
  id int(11) unsigned NOT NULL auto_increment,
  name varchar(64) default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;

INSERT INTO people VALUES 
  (1,'user_a'),
  (2,'user_å'),
  (3,'user_ä');

select * from people;

SET NAMES utf8;
ALTER TABLE people engine=MyISAM default character set utf8;
ALTER TABLE people CHANGE name name BLOB;
ALTER TABLE people CHANGE name name varchar(64) CHARACTER SET utf8;

select * from people;
</span></code></pre></td></tr></table></div></figure></notextile></div>




<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
# case where utf8 data was enterd into a table with latin1 and later needs conversion to utf8

SET NAMES latin1;

drop table people;

CREATE TABLE people (
  id int(11) unsigned NOT NULL auto_increment,
  name varchar(64) default NULL,
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;

SET NAMES utf8;

INSERT INTO people VALUES 
  (1,'user_a'),
  (2,'user_å'),
  (3,'user_ä');

select * from people;

ALTER TABLE people engine=MyISAM default character set utf8;
ALTER TABLE people CHANGE name name BLOB;
ALTER TABLE people CHANGE name name varchar(64) CHARACTER SET latin1;
ALTER TABLE people CHANGE name name varchar(64) CHARACTER SET utf8;

select * from people;
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>
  
  


      </article>
    
    <div class="pagination">
      
        <a class="prev" href="/blog/page/6/">&larr; Older</a>
      
      <a href="/blog/archives">Blog Archives</a>
      
      <a class="next" href="/blog/page/4/">Newer &rarr;</a>
      
    </div>
  </div>

  
  <div class="span4 sidebar">
    <div class="well">
      
        <section>
  <h2>Recent Posts</h2>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/17/shelling-out-from-a-ruby-app-to-a-ruby-app-without-bundler-conflicts/">Shelling out from a ruby app to a ruby app without bundler conflicts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/29/winning-two-gsma-global-mobile-awards/">Winning Two GSMA Global Mobile Awards</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/09/looping-through-large-and-slow-datasets-in-ruby/">Looping through large and slow datasets in Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/03/quick-tip-ios-and-web-graphics-in-illustrator/">Quick Tip: iOS and web graphics in Illustrator</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/07/26/patents-gone-crazy/">Patents Gone Crazy</a>
      </li>
    
  </ul>
</section>

<section>
  <h2>GitHub Repos</h2>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/eimermusic">@eimermusic</a> on GitHub
  
  <script type="text/javascript">
    $(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'eimermusic',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h2>Latest Tweets</h2>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
    <a href="http://twitter.com/eimer" class="twitter-follow-button" data-show-count="false">Follow @eimer</a>
  
</section>





      
    </div>
  </div>



</div>
      </div>
    </div>
    <footer class="footer"><p>
  Copyright &copy; 2013 - Martin Westin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> -
  
    <span class="credit">Theme by <a href="http://brianarmstrong.org">Brian Armstrong</a></span>
  
</p>
</footer>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>








  </div>
</body>
</html>
