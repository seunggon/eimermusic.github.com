
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My New Home</title>
  <meta name="author" content="Martin Westin">

  
  <meta name="description" content="Part of the series Milestones in Music (1988) I listened to the soundtrack for at least a few years before I managed to see the actual film. I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://eimer.co/blog/page/4">
  <link href="/favicon.ico" rel="icon">

  <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="/assets/font-awesome/css/font-awesome.css" rel="stylesheet" type="text/css">

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

  <link href="/atom.xml" rel="alternate" title="My New Home" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-11893308-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    data-spy="scroll">

  <div class="container">
    <header class="jumbotron subhead" id="overview">
      
<div class="subscribe">
  <table>
    <tr>
      <td><span>Get Updates: &nbsp;</span></td>
      
      
      <td><a href="/atom.xml" class="btn"><i class="icon-cog"></i> By RSS</a></td>
      
      
      <td><a href="http://twitter.com/eimer" class="btn"><i class="icon-twitter-sign"></i> On Twitter</a></td>
      
    </tr>
  </table>
</div>

<h1 class="title">My New Home</h1>

  <p class="lead">migrated from the 10 year-old eimermusic.com</p>


      <div class="navbar">
  <div class="navbar-inner">
    <div class="container" style="width: auto;">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <div class="nav-collapse">
                <ul class="nav">
          <li><a href="/">Home</a></li>
          <li><a href="/music">Music</a></li>
          <li><a href="/photos">Photos</a></li>
          <li><a href="/portfolio">Portfolio</a></li>
          <li><a href="/about">About</a></li>
        </ul>

        
          <form action="http://google.com/search" method="get" class="navbar-search pull-left">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:eimer.co" />
              <input type="text" name="q" results="0" placeholder="Search" class="search-query span2" />
            </fieldset>
          </form>
        
        
      </div><!-- /.nav-collapse -->
    </div>
  </div><!-- /navbar-inner -->
</div>

    </header>
    <div id="main">
      <div id="content">
        <div class="row">
  
  <div class="span8 blog-index">
    
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/07/03/philip-glass-the-thin-blue-line-ost/">Philip Glass - the Thin Blue Line (OST)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-03T00:00:00+02:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://www.eimermusic.com/cms/wp-content/uploads/2010/07/thin_blue_line.jpg" alt="" title="The Thin Blue Line" width="170" height="167" class="hang-2-column size-full wp-image-114" /></p>

<p>Part of the series Milestones in Music</p>


<p><em>(1988)</em></p>

<p>
I listened to the soundtrack for at least a few years before I managed to see the actual film. I really love that a lot of dialogue is left on top of the music but I also wish I could listen to the score on its own. Philip Glass at his finest.
</p>

</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/07/02/developing-my-first-iphone-app/">Developing My First iPhone App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-02T00:00:00+02:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While my friends were playing Red Dead Redemption I finally got my feet wet in the iPhone SDK. My first app is available on the App Store after a surprisingly short development time.</p>

<p>The app is called Extraction and it is a simple Espresso timer for coffee nerds like myself. You can read more about it at <a href="http://extraction.eimermusic.com">extraction.eimermusic.com</a>. Describing the app is not what this post is about.</p>

<p>What I wanted to write about was the design, development and the resources that got me going. I have never before coded in Objective-C or any C-based language for that matter. The closest environment I have developed in is Flash. Kind of ironic considering the current Apple - Adobe relationship.</p>

<p>I got from 0 to a submitted app in about 2 weeks&#8230; And to that I should add that I could only read, watch and code briefly every now and then. I was taking care of my 1 year old son full time during these weeks. I estimate I coded, designed and tinkered for around 15 - 20 hours total.</p>

<p>So what helped me get started and actually complete a real application with navigation controller, camera support and data persistence?</p>

<h2>The Idea</h2>

<p>Being an espresso nerd I had a look around for a timer application that would let me time my shots and mark that &#8220;lap time&#8221; for when the coffee first starts flowing. The ones I looked at didn&#8217;t do it for me. A bas example is the built-in stopwatch on the iPhone. Marking a lap time makes the &#8220;main&#8221; timer start over from 0. Good for running laps but bad for marking the pre-brewing of an espresso extraction.</p>

<p>Developing an app that did this was just my best excuse to try developing for the iPhone. I have been wanting to do that ever since I first got my original iPhone in Feb 2008.</p>

<h2>The Design</h2>

<p>The initial idea had been brewing for a long time. By contrast, everything about both the design and the development was very quick and intuitive.</p>

<p>The feature set, or &#8220;interaction design&#8221; if I want to be posh, was arrived at by a bit of iterative trial and error. My initial thought was completely flawed once I started using it. So flawed I wont even go into it. I quickly realised I could store the times. Once that was working I realised I would want to add some notes about the particular shot. And then the obvious thing was to add camera support to allow for a photo of the shot to be saved along with the times and notes.</p>

<p>Once the 1.0 features were sort of working I started to look into the visuals of the app. It started with raw GUI elements in Interface Builder which I sized and placed until they felt ok. Then I basically just imported a screenshot into Illustrator and drew vector graphics for each element and exported them as png files. It is a good thing I prefer Illustrator to Photoshop since making high resolution graphics for the iPhone 4 was simply a matter of exporting from Illustrator @ 200%. Done!</p>

<p>The logo was just a manual vector trace of the first hit on Google images when searching for coffee beans. I am sure you can find the same image by <a href="http://www.google.com/images?q=coffee+bean">searching now</a>.</p>

<p>I got the colors for the application and the logo from the gallery at Color Schemer. I chose a scheme called <a href="http://www.colorschemer.com/schemes/viewscheme.php?id=3953">Cold Espresso</a> which looked and sounded appropriate.</p>

<h2>The Development</h2>

<p><a href="http://developer.apple.com/iphone">Downloading the SDK</a> and opening Xcode frankly got me nowhere. There is a certain amount of implied knowledge needed. I aquired this knowledge mainly from the following sources.</p>

<p><a href="http://www.lynda.com/home/DisplayCourse.aspx?lpk2=48369">Lynda.com has a very nice video series</a> on the subject that a friend of me downloaded and let me watch. Thanks Mikael. These videos are very short and to the point. Nothing like the sleep inducing Stanford lectures on iTunes. You quickly get a feel for how to code in Xcode and important elements in UIKit are exemplified one by one. Very nice.</p>

<p><a href="http://www.bignerdranch.com/book/iphone_programming_the_big_nerd_ranch_guide">iPhone Programming: The Big Nerd Ranch Guide</a>, released only a few months ago was my other main source of knowledge. This one goes a lot deeper than the video series but still keeps the information grounded in the code and not too abstract and philisofical. From this book you really learn a lot of good practices and essential things you need to know to actually make a finished iPhone app for the App Store. Highly recommended.</p>

<p>I did buy another SDK book but I haven&#8217;t even opened it and can&#8217;t remember the name. It cost a lot though. I remember that part.</p>

<p>When I got lost on some detail Google almost always directed me to <a href="http://stackoverflow.com/">stackoverflow.com</a>. They got the answers to everything there. A few specific problems had their answers at <a href="http://www.iphonedevsdk.com/forum/" >iphonedevsdk.com</a>. They have a great forum there.</p>

<p>After embracing Objective-C and all its square brackets and very long verbose method names&#8230; I love it. Objective-C is pretty cool but Cocoa Touch is amazing. Rubyists usually joke that you can do almost anything in Ruby with one line of code&#8230; I feel the same about Cocoa Touch. And messaging in Obj-C is really wonderful. you never have to wonder what an argument is doing since they are all labeled as part of the method name. Strange at first but fantastic now.</p>

<h2>The Website</h2>

<p>Just as I was ready to submit to the App Store I noticed that I needed to have a support website for the app. I uploaded the app and gave myself a very tight deadline to complete a decent looking one-page website for my little app. I&#8217;d say the website looks OK at first glance. But look a little closer and you can clearly see it was conceived, designed, copy-written and coded in about 3 hours.</p>

<p>That is all I can think of writing. Anything you want to know more about?</p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/06/25/extraction-1-0-and-1-1/">Extraction 1.0 and 1.1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-06-25T00:00:00+02:00" pubdate data-updated="true">Jun 25<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://extraction.eimermusic.com/"><img src="http://www.eimermusic.com/cms/wp-content/uploads/2010/06/1.0_screen_1-170x170.png" alt="" title="Extraction 1.0" width="170" height="170" class="no-hang size-thumbnail wp-image-104" /></a></p>

<p>Version 1.0 of Extraction, my first iPhone app, was released on the App Store yesterday. I am very excited about the whole thing. Duh!</p>

<p>Version 1.1 has already been submitted for review. It adds iOS4 compatibility and iPhone 4 high-res graphics.</p>

<p>Extraction is a simple timer and records-keeper for espresso brewing. You may need to be unhealtily interested in making coffee to get the purpose the app. You can read a bit more about the features <a href="http://extraction.eimermusic.com">on the extraction website</a> and you can download the app and check it out <a href="http://itunes.apple.com/WebObjects/MZStore.woa/wa/viewSoftware?id=377768979&mt=8" >on the App Store</a>.</p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/05/09/modifying-a-projekktor-theme/">Modifying a Projekktor Theme</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-09T00:00:00+02:00" pubdate data-updated="true">May 9<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.projekktor.com/">Projekktor</a> is a most excellent open-source video player for the web. It requires javascript but that is totally worth it. You get cross-browser compatibility, flash fallback, consistent GUI across browsers and much more. What i will explain in this short article is how to modify the GUI part.</p>

<p> The first thing I wanted to know was: <strong>What does the html look like?</strong> Since it is generated by javascript it is not readily apparent so here is the html structure of the video &#8220;controls&#8221;.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
<div id="imzffxow_controls" class="ppcontrols" style="display: block; ">
  <div id="imzffxow_fsexit" class="ppfsexit" style="display: none; "></div>
  <div id="imzffxow_fsenter" class="ppfsenter" style="display: block; "></div>
  <div id="imzffxow_play" class="ppplay" style="display: none; "></div>
  <div id="imzffxow_pause" class="pppause" style="display: block; "></div>
  <div id="imzffxow_prev" class="ppprev"></div>
  <div id="imzffxow_next" class="ppnext"></div>
  <div id="imzffxow_title" class="pptitle">Wrath - YOUTUBE Flash API 2/4</div>
  <div id="imzffxow_tleft" class="pptleft">00:18 / 03:46</div>
  <div id="imzffxow_scrubber" class="ppscrubber">
    <div id="imzffxow_playhead" class="ppplayhead" style="width: 8.21199%; "></div>
    <div id="imzffxow_loaded" class="pploaded" style="width: 100%; "></div>
  </div>
  <div id="imzffxow_vslider" class="ppvslider" style="">
    <div id="imzffxow_vknob" class="ppvknob" style="left: 42.75px; "></div>
  </div>
  <div id="imzffxow_mute" class="ppmute"></div>
  <div id="imzffxow_vmax" class="ppvmax"></div>
</div>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>The enclosing div (classed ppcontrols) is itself enclosed inside a set of tags that are positioned and make fixed-size box (the size of the video element). This makes things nice and workable. You can position and set the size for ppcontrols and then place each element in relation to this div.</p>

<p>I will continue to call each control element by it&#8217;s class name since these are what you target in your css. Just to make things really obvious, here is a screenshot with the class-names added.</p>

<p><a href="http://www.eimermusic.com/articles/modifying-a-projekktor-theme/attachment/ppcontrols/" rel="attachment wp-att-99"><img src="http://www.eimermusic.com/cms/wp-content/uploads/2010/05/ppcontrols.png" alt="Projekktor Controls" title="ppcontrols" width="602" height="203" class="alignnone size-full wp-image-99" /></a></p>

<p>If you want a different look but like the general dimensions you can just start replacing the graphics in the theme folder of projekktor.</p>

<p>To my eyes the standard theme looks very nice. I wanted to keep the same look but make it resize to fit various video sizes. To achieve this I needed to make the size of the main ppcontrols div relative to the video frame. Instead of a fixed width I ended up with this css.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:css </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
.ppcontrols {  
    position: relative;
    left: 20px;
    margin-right: 40px;
    display: block;
    width: auto;
    height: 87px;
    margin-top: -110px;
    border: solid 2px #fff;
    -webkit-border-radius: 12px;
    -moz-border-radius: 12px;
    border-radius: 12px;
    background: transparent url(projekktor/ctrl-bg.png) 0 0 repeat-x;
    z-index:8000;
    padding: 0px;
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>This creates a control area that always stretches to 20px from the left and right edges. As you can see I also added a css border (with radius) and a new background to get close to the original graphics of the theme while still being flexible horizontally.</p>

<p>The I proceeded to position the elements relative to one of the edges or the middle of the controls area. For example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:css </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
.ppfsenter {
...
    top: 50px;
    right:10px;
...
}
.ppplay {
...
    left: 50%;
    margin-left: -17px;
...
}
.ppscrubber {
...
    left: 13px;
    right: 13px;
...
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>With these minor changes to the css the full-screen buttons stick to the right edge and the play/pause buttons stick to the center. Items like the scrubber and the title are positioned in a similar way to the main ppcontrols div. I chose a different css to get the results this time &#8230; just for the variation. Use whichever one you prefer.</p>

<p>The results of my modifications are available for download if you want to take a look at all of it or give it a test-drive.</p>

<p>&#8220;demo&#8221; (just the v0.6.1 release unpacked and edited)
<a href="http://dev.eimermusic.com/projekktor/readme.html">http://dev.eimermusic.com/projekktor/readme.html</a></p>

<p>the css and images in a zip-file
<a href="http://dev.eimermusic.com/projekktor/projekktor_theme_fluid.zip">http://dev.eimermusic.com/projekktor/projekktor_theme_fluid.zip</a><br />
<a href="http://dev.eimermusic.com/projekktor/projekktor_theme_fluid.tar.gz">http://dev.eimermusic.com/projekktor/projekktor_theme_fluid.tar.gz</a></p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/01/18/my-work-at-the-2010-ces-in-las-vegas/">My Work at the 2010 CES in Las Vegas</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-01-18T00:00:00+01:00" pubdate data-updated="true">Jan 18<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>This is so cool</h2>

<p>[caption id=&#8221;attachment_95&#8221; align=&#8221;alignnone&#8221; width=&#8221;440&#8221; caption=&#8221;Paul Jacobs (left) and Eric Topol (right) demo Mobile Baby at CES&#8221;]<a href="http://www.eimermusic.com/general-interest/my-work-at-the-2010-ces-in-las-vegas/attachment/ces-keynote/" rel="attachment wp-att-95"><img src="http://www.eimermusic.com/cms/wp-content/uploads/2010/01/ces-keynote.jpg" alt="Paul Jacobs (left) and Eric Topol (right) demo Mobile Baby at CES" title="Mobile Baby demo at CES" width="440" height="225" class="size-medium wp-image-95" /></a>[/caption]</p>

<p>My work at Great Connection: developing, filing patents, taking meetings, and most of all drinking coffee, has finally been outed is a significant way. Dr. Paul E. Jacobs, the CEO of Qualcomm and Dr. Eric J. Topol, a most prominent medical doctor working to improve IT in medicine, demonstrated Mobile Baby at the Consumer Electronics Show in las Vegas on January 8, 2010.</p>

<p>Mobile Baby is the coolest application in the system I develop at work. The service transmits medical images from echo machines (ultrasound), CTs, MRs or any similar digital &#8220;x-ray&#8221; type device, to any mobile phone, any email inbox and a few social networking apps.</p>

<p>I am humbled and very happy that these &#8220;big shot americans&#8221; have taken notice of the work have done and say such nice things about it.</p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/12/04/why-isset-in-php-can-be-misleading/">Why Isset() in PHP Can Be Misleading</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-12-04T00:00:00+01:00" pubdate data-updated="true">Dec 4<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I thought this was worth noting even though <a href="http://www.php.net/manual/en/function.isset.php#89651">a comment on php.net explain it very well</a>.</p>

<p><strong>You can not rely on isset() for associative arrays unless you know for a fact you are checking an array.</strong></p>

<p>That is: in case the variable you think is an array is in fact a string you will be in trouble. The reason being that you can access characters in a string using array notation. And since PHP is dynamically typed you can end up checking a string by mistake (or by malicious data from the browser).</p>

<p>Since CakePHP is full of associative arrays this is bound to happen to most people sooner or later. I have stumbled on this once when I was dealing with serialized data. I used isset() to check wether the data was serialized or not.</p>

<p>Here is a little example. Both checks will return true.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
<?php
$test = array(
    'data' => 'some data'
);
$test2 = array(
    'data' => array('key'=>'val')
);

echo isset($test['data']['key']);
echo ' - ';
echo isset($test2['data']['key']);
?>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>There are a number of ways to get around this problem. One if to use array_key_exists(). Another is to use is_array() alongside isset().</p>
</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/02/designing-a-modular-application-using-cakephp-plugins/">Designing a Modular Application Using CakePHP Plugins</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-02T00:00:00+02:00" pubdate data-updated="true">Sep 2<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This article will try to explain how I build a modular application using plugins. I will cover how I implement them and integrate them into the main application.
</p>


<h2>Definition</h2>

<p>There are a lot of different ideas around about what to put into the CakePHP plugins directory. In this article a plugin extends the application kind-of like a plugin in Photoshop.</p>

<ul>
    <li>A plugin does not extend CakePHP or &#8220;any&#8221; application. It is specific to &#8220;this&#8221; application.</li>
    <li>A plugin may (or rather should) depend on the application.</li>
    <li>The application may not depend on any one plugin.</li>
</ul>


<h2>Context</h2>

<p>We need some context. An example application and how it makes use of plugins. I have chosen the application I continually develop at work. It is a system for communicating with mobile phones. Primarily via SMS and MMS. (That is: text messages and picture/video messages to most people.) I will use simplified and generalised features of this application to exemplify the design and implementation of plugins.</p>

<h2>The design</h2>

<p>The application has certain obvious core features. User management, managing phone numbers, sending SMS and MMS, receiving SMS and MMS, reporting on all transactions and other similar features.</p>

<p>Each concrete end-user feature is implemented as a plugin.
A few examples:
A newsletters module used to send offers and news to customers.
A feedback module used to receive and automatically publish incoming feedback from customers on the client&#8217;s website among other things.
An opinions module to manage quick opinion polls.
A subscriptions module and many others.</p>

<p>Each of these make use of incoming and/or outgoing SMS and MMS messages in some way. Each one uses stored phone numbers. They all manage these things by making use of core features.</p>

<h2>How plugins talk to the main application</h2>

<p>This is the simple and obvious bit. A plugin can very simply just extend or associate itself with some resource in the main application.
As an example (finally some code!), a subscriber model would look like this.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
<?php  
class SubsSubscriber extends SubsAppModel { 
    var $name = 'SubsSubscriber';     
    var $belongsTo = array( 
        'Phone', 
        'SubsSubscription'=>array( 
            'className'    => 'Subs.SubsSubscription', 
            'counterCache' => true 
        ) 
    ); 
} 
?>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>Not only does the subscriber belong to a subscription, it also belongs to a phone. Creating a Subscriber involves registering the subscriber&#8217;s phone number with the Phone model. This ensures that there are no duplicate numbers, that any restrictions put on a certain phone is retained across the app. Things like that. The Phone model implements this registration method.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
function register($number) { 
    $number = clean_phone($number); // utility function to normalize number formatting 

    // not a real phone number: abort 
    if ( empty($number) ) { 
        return false; 
    } 
     
    // look for existing registration  
    $phone = $this->find('first',array( 
        'conditions'=>array( $this->alias.'.number'=>$number ) 
    )); 
     
    if ( !empty($phone) ) { 
        // found it, return it 
        return $phone; 
    } 

    // new number 
    $this->create(); 
    $data = array( 
        $this->alias=>array( 
            'number'=>$number 
        ) 
    ); 
     
    if ( $this->save($data) ) { 
        return $this->read(); 
    } else { 
        return false; 
    }     
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>That is really the basics behind how plugins interact with the main application. Similarly when a plugin needs to send an SMS, this is done using the SendSmsComponent in the main application. This component abstracts all the messy SOAP garbage phone-operators implement. :) Me, cranky? You bet!</p>

<h2>How about the other way around?</h2>

<p>The less obvious part is how the main application communicates back to the plugins. If I was starting out today I would certainly implement Eventful from cakealot.com, or something like Teknoid&#8217;s observer pattern. I did something a bit different.</p>

<p>I keep all plugins in a table accessed via a model. That way I can have an administrative GUI to activate and deactivate different plugins for different clients. I also simplifies handling of permissions to plugins and menu-generation and other things. It is possible to get by with simply reading the app/plugins directory and caching that.</p>

<p>AppController implements some empty methods used as callbacks or event handlers of sorts. As an example, when an SMS message is received in the main application it parses the message and locates the plugin that should receive it. It stores the message in the central SMS model and notifies the plugin that a new message with the ID=123 has arrived and that the plugin should do something about it.</p>

<p>What happens next if of-course all up to the plugin. It may register the sender as a new subscriber, unregister the sender, post the message to the web, send an email, reply automatically&#8230; anything it wants. The point is that it is up to the plugin to decide.</p>

<p>The application does this via the much debated requestAction:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
$this->requestAction('/'.$module['Module']['name'].'/on_incoming_sms/'.$saved['IncomingSms']['id'], array('return')); 
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>And each plugin would implement this method to do something with the message. This is done in the &#8220;PluginnameController&#8221; as the request goes to /pluginname/on_incoming_sms/123. There is a positive side-effect to this. If I want some core feature to be called in this way I can make add a controller to the table of &#8220;modules&#8221; and requestAction will never know the difference. (This is why I still use a string url.)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
function on_incoming_sms($id = null) { 
    $this->autoRender = false; 
    if ( !isset($this->params['requested']) || empty($id) ) { // check that we are contacted "from within" 
        return false; 
    } 
    // do something useful here and return the id as confirmation 
    return $id; 
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>Now I feel the need to get a bit on the defensive. I can almost hear people shouting about thin controllers, fat models and the evil of requestAction. This is communication. that is the exactly what controllers are meant to do. In Cake this is usually between the browser and the models but in this case it is between the app and it&#8217;s plugins. I don&#8217;t have any such logical reason for using requestAction except that is is by far the most convenient way of achieving this kind of communication. Since these calls are usually done from either an API call (incoming sms) or from a cron shell any increase in request time is not a great priority. People get annoyed by an extra 0.4sec, a cron job doesn&#8217;t :)</p>

<h2>Speaking of Cron jobs</h2>

<p>Housekeeping is done via cron. I have cron call a Cake shell every hour. This shell finds all modules and calls each one in turn. Again, the main application does not know or care about what each module is up to. One may update a cached view, another may remove expired items, another may send scheduled messages and guess what the Reports module does each hour?</p>

<p>This is an example of such a shell</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
class HourlyShell extends Shell { 

    var $tasks = array('LogRotation'); 
    var $uses = array('Module'); 
     
    function main() { 
        $this->out('Hourly shell updates'); 
        $this->log('Hourly shell updates @ '.date('Y-m-d H:i:s'), 'cron'); 
         
        $this->LogRotation->execute(); 
         
        $this->update_plugins();         
    } 
     
    function update_plugins() { 
        $this->out('Updating plugins:'); 
        $modules = $this->Module->find('list', array( 
                'fields' => 'Module.controller', 
                'conditions' => array('Module.installed'=>'1'), 
                'recursive' => -1 
            ) 
        ); 

        foreach ( $modules as $module) { 
            $this->out('> '.$module); 
            $this->requestAction('/'.$module.'/on_hourly_update', array('return'=>true, 'bare'=>1)); 
        } 
    } 
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>The method being called will typically just pass the call along to one or more parts of the module that need to do something periodic. For example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
function on_hourly_update() {
    // the template in AppController can be used to check that the call is legitimate.
    if ( parent::on_hourly_update() ) {
        $this->SubsSubscription->deleteExpired();
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h2>A bonus trick</h2>

<p>One cool thing that may not be apparent is that it is very easy to build a new feature as a normal controller and then turn it into a plugin. The trick is to name the plugin after the controller it should replace. Then you take the controller and make it the PluginnameController for that plugin. Cake will pass any call to that controller automatically. Example time:</p>

<p>/news/edit/123 - would be seen as /controller/action/param
/news/edit/123 - can also be be seen as /plugin/controller/action
but since there is no edit controller in the news plugin Cake will try:
/news/edit/123 - as /plugin{/pluginname}/action/param ending up in the PluginnameController and the edit action.</p>

<p>You will have to move the model and views to the plugin too, of-course.</p>

<h2>Closing remarks</h2>

<p>That is the basic gist of how I have chosen to design a modular system based on plugins. If you feel I have left something out, please comment and I will answer or update the article.</p>

<p>Plugins make up most end-user features.
Plugins rely on models, components, elements and other code from the main application.
The main application can pass events and information to plugins via the PluginnameController in each plugin.</p>

<p>I have left out tricks and hacks to keep the article focused. In the real application I use a patch to the dispatcher class that reformats urls for plugins. News plugin has NewsMessagesController but showing /news/news_messages/index in the url is redundant to say the least. The patch allowsme to use urls like /news/messages/index and have the dispatcher prepend the plugin name to the controller name. Since most urls point to plugins I chose to patch the core for this feature. It is not necessary to do any such patch to make use of plugins but for me it made plugins a more attractive option as the foundation of most features.</p>

<p>That&#8217;s all. Thanks for reading.</p>

<p style="font-size:11px;">published @ <a href="http://bakery.cakephp.org/articles/view/designing-a-modular-application-using-cakephp-plugins">http://bakery.cakephp.org/articles/view/designing-a-modular-application-using-cakephp-plugins</a>
</p>

</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/29/javascript-variable-definitions/">Javascript Variable Definitions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-29T00:00:00+02:00" pubdate data-updated="true">Jun 29<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The variable scope in javascript can still surprise me. This is a nice one I debugged today:</p>

<p>A variable that is not defined by &#8220;var&#8221; have a global scope. This can be a real pain since the globalization is implicit and easy to forget.</p>

<p>I forgot the &#8220;var&#8221; when writing a for loop and could not for the life of me figure out what happened when the i-variable got mysteriously reset.</p>

<p>This is an example of a foor loop (in one()) that will never finnish since i is being reset in two(). Defining &#8220;var i=0&#8221; and all is well.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:javascript </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
function one() {
    for (i=0;i<20;i++){
        if (i > 18) {
            two();
        }
    }
}
function two() {
    for (i=0;i<5;i++){
    }
    alert('two');
}
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/06/04/starschema-olap-setup-for-reporting-in-cakephp/">StarSchema (OLAP) Setup for Reporting in CakePHP</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-04T00:00:00+02:00" pubdate data-updated="true">Jun 4<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
When you need to gather statistics and reporting data from a large number of transactions (easily >1&#8217;000&#8217;000 rows) you need to transfer that data over to a reporting-friendly format to keep request times down. One popular database design for this is called a Star Schema. This is a simple re-usable StarSchema setup for CakePHP.
</p>




<p>
To make heads and tails of the following it help to have some basic understanding of star schemas and why anyone would use OLAP. If your gut-reaction is &#8220;Why not just do a find on the transaction data and format a reporting view from that?&#8221; then you should at least give the following page a look.
</p>


<p><a href="http://ciobriefings.com/Publications/WhitePapers/DesigningtheStarSchemaDatabase/tabid/101/Default.aspx">http://ciobriefings.com/&#8230;</a></p>

<h4>When do I need this?</h4>


<p></p>

<ul>
<li>The data you are reporting on is growing and your app is slowing down</li>
<li>The data is not stored the way you want to &#8220;view it&#8221; in your reports</li>
<li>You need to &#8220;view&#8221; your data in various different ways in your reports</li>
</ul>




<h4> Disclaimer</h4>


<p></p>

<p>
This article is to provide an implementation of a star schema setup for Cake. You still need to know how to DESIGN your schema. It is very important to plan ahead and create a schema that will accomodate ALL the ways (dimensions) you want to display your data. It is  a bit tricky to alter the schema afterwards.
</p>


<p>
This code uses some of ugly messy code that improves performance. The database goes against some Cake conventions (no pk!). It also contains some ugly messy code that is the fault of the author (me). Also this setup has only been run and tested on MySQL and uses a custom dbo that can put dynamic data into a Model&#8217;s resultset.
</p>


<p>
This article is about the star schema implementation. It could be extended to aggregated tables to improve display performance even further. How to do this is not explained here.
</p>




<h4>Pieces to the puzzle</h4>


<p></p>

<ul>
<li>Extended DBO</li>
<li>Fact Model</li>
<li>Dimension Models</li>
<li>A Controller example</li>
</ul>


<h3>Extended DBO</h3>

<p>
I found this extended DBO a long time ago. Credit should go where credit is due but I have lost the reference to the original author. The DBO did more but I picked out the resultSet() method which is what we need here. To get an extended mysqli driver replace the &#8220;mysql_&#8230;&#8221; methods with &#8220;mysqli_&#8230;&#8221;
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
require_once (LIBS . 'model' . DS . 'datasources' . DS . 'dbo' . DS . 'dbo_mysql.php');
// app/models/datasources//dbo/dbo_mysql_ex.php
class DboMysqlEx extends DboMysql {
    var $description = "MySQL DBO Driver - Extended";
    
    // Extended 'resultSet' to allow alias processing
    // Fields should contain '((something)) AS Model__field'
    function resultSet(&$results) {
        $this->results =& $results;
        $this->map = array();
        $num_fields = mysql_num_fields($results);
        $index = 0;
        $j = 0;

        while ($j < $num_fields) {
            $column = mysql_fetch_field($results,$j);
            if (!empty($column->table)) {
                $this->map<$index++> = array($column->table, $column->name);
            } else {
                if (strpos($column->name, '__')) {
                    $parts = explode('__', $column->name);
                    $this->map<$index++> = array($parts<0>, $parts<1>);
                } else {
                    $this->map<$index++> = array(0, $column->name);
                }
            }
            $j++;
        }
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h3>Fact Model</h3>

<p>
The abstract fact model, the super, the parent, which all concrete fact models extend.
</p>


<p>
FactModel implements a few custom methods that are common among fact models. findFacts() is a custom find method that joins the fact model with all its dimensions and returns a nice data array with the requested fact. saveFact() is a custom save method that uses a custom query to automatically update each row if it exists already. This is done to improve performance (a lot).
</p>


<p></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
/*
 *  Abstract super-model for Facts
 */
class FactModel extends AppModel {

    var $name = 'FactModel';
        
    // I prefer using findFacts() directly but like this you could quickly make a find type of the whole thing
    function find($type, $options = array()) {
        switch ($type) {
            case 'facts':
                return $this->findFacts($options<'fact'>,$options);
            default:
                return parent::find($type, $options);
        }
    }

    // this method will always be specific to each fact model
    function gather( $start_time = null ) {
        debug($this->alias.' must implement gather()');
        return false;
    }

    //-- 'mapped' re-arranges the results in an array-hierarchy according to the group parameter.
    //-- E.G. grouping by weekday might return array keys mon,tue... instead of 0,1...
    function findFacts($fact, $options) {
        $defaults = array(
            'conditions' =>'',
            'fields' =>array(),
            'order' =>'',
            'group' =>'',
            'mapped'=>false
        );
        $options = array_merge($defaults,$options);
        
        $dimensions = $this->getAssociated('belongsTo');
        
        $joins = $this->useTable.' AS '.$this->alias;
        $this_name = $this->alias;
        foreach ( $dimensions as $k => $dim ) {
            $dimension = $this->$dim->useTable.' AS '.$dim;
            $fk = $this->belongsTo<$dim><'foreignKey'>;
            $joins = "($dimension INNER JOIN $joins ON $dim.id = $this_name.$fk)";
        }
        $fields = array_merge($options<'fields'>,array($fact.' AS '.$this->alias.'__fact',$options<'group'>,$options<'order'>));
        $fields = array_unique($fields);
        
        $db =& ConnectionManager::getDataSource($this->useDbConfig);
        $query = $db->renderStatement('select', array(
            'conditions' => $db->conditions($options<'conditions'>, true, true, $this),
            'fields' => join(', ', $fields),
            'table' => '',
            'alias' => '',
            'order' => $db->order($options<'order'>),
            'limit' => '',
            'joins' => $joins,
            'group' => $db->group($options<'group'>)
        ));             
        $raw_facts = $this->query($query);
        
        if ( $options<'mapped'> ) {
            $group_str = str_replace(' ','',$options<'group'>);
            $groups = explode(',',$group_str);
            $last_group = array_pop($groups);
            
            $mapped_facts = array();
            foreach ( $raw_facts as $key => $val ) {
                $domain =& $mapped_facts;
                foreach ( $groups as $group ) {
                    $gKey = Set::extract($raw_facts,$key.'.'.$group);
                    if ( !isset($domain< $gKey >) ) {
                        $domain< $gKey > = array();
                    }
                    $domain =& $domain< $gKey >;
                }
                $gKey = Set::extract($raw_facts,$key.'.'.$last_group);
                $domain<$gKey> = $val;
            }

            return $mapped_facts;
        } else {
            return $raw_facts;
        }
    }
    
    
    function saveFact($fact) {
        
        $keys = array_keys($fact<$this->alias>);
        $values = array_values($fact<$this->alias>);
        
        $fields = $this->_getFactFields();
        $update = '';
        foreach ( $fields as $field ) {
            $update .= ' `'.$field.'` = '.$fact<$this->alias><$field>.',';
        }
                
        $query = 'INSERT INTO `'.$this->useTable.'` (`'. implode('`,`', $keys) .'`) VALUES ('. implode(',', $values) .') ON DUPLICATE KEY UPDATE'.substr($update,0,-1);
        $this->query($query);
    }
    
    function _getFactFields() {
        $fields = array();
        foreach ( $this->_schema as $field => $params ) {
            if ( !isset($params<'key'>) ) {
                $fields<> = $field;
            }
        }
        return $fields;
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h3>Example FactSentSms</h3>

<p>
A simple example of a concrete model extending FactModel. This one tracks outgoing SMS messages for a few dimensions. More on dimensions shortly.
</p>


<p>
In this example the gather() method is quite simple. It could contain any number of complex calculations or pulling of associated data. This method does all the heavy lifting of the data and an initial gathering of an existing transaction table can take a long time.

Notice that the fact table contains a field referencing the original primary key from the transaction table. This is to ensure that we can update the data without accidentally overwriting rows or creating duplicates. The table definition makes a unique key of the composite of all dimensions and this id. There is no primary key, by design.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
CREATE TABLE `fact_sent_smses` (
  `dimension_time_id` int(11) unsigned NOT NULL,
  `dimension_client_id` int(11) unsigned NOT NULL,
  `dimension_type_id` int(11) unsigned NOT NULL,
  `dimension_module_id` int(11) unsigned NOT NULL,
  `outgoing_id` int(11) unsigned NOT NULL,
  `num_smses` int(11) default '0',
  `response_code` int(11) default '0',
  `tarif_total` int(11) default '0',
  UNIQUE KEY `dimension_time_id` (`dimension_time_id`,`dimension_client_id`,`dimension_type_id`,`outgoing_id`,`dimension_module_id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE=utf8_binary
</span></code></pre></td></tr></table></div></figure></notextile></div>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
/*
 *  Tracks outgoing messages with daily grain.
 */
App::import('Model','FactModel');
class FactSentSms extends FactModel {
    var $name = 'FactSentSms';
    var $useTable = 'fact_sent_smses';
    
    // dimensions are specified as belongsTo accosiations.
    var $belongsTo = array('DimensionTime','DimensionClient','DimensionType','DimensionModule');


    // gather new facts from transation model, run periodically from cron shell
    // this method will always be specific to each fact model
    function gather( $start_time = null ) {
        if ( empty($start_time) ) {
            $start_time = strtotime( '-1 hour', time() );
        }
        $start_date = date('Y-m-d H:i:s', $start_time);

        $OutgoingSms =& ClassRegistry::init('OutgoingSms');
        $page = 1;
        while ( $all = $OutgoingSms->find('all', array(
            'fields'=>array(
                '*',
                'DATE(OutgoingSms.created) AS OutgoingSms__date',
                'TIME(OutgoingSms.created) AS OutgoingSms__time',
                'DAYOFWEEK(OutgoingSms.created) AS OutgoingSms__day_of_week',
                'DAYOFMONTH(OutgoingSms.created) AS OutgoingSms__day_of_month',
                'DAYOFYEAR(OutgoingSms.created) AS OutgoingSms__day_of_year',
                'MONTH(OutgoingSms.created) AS OutgoingSms__month',
                'QUARTER(OutgoingSms.created) AS OutgoingSms__quarter',
                'YEAR(OutgoingSms.created) AS OutgoingSms__year'
            ),
            'conditions'=>array(
                'OutgoingSms.created >' => $start_date
            ),
            'recursive'=>'0',
            'order'=>'OutgoingSms.created ASC',
            'limit'=>'5000',
            'page' => $page++
        )) ) {
            foreach ( $all as $one ) {
                // Associate this fact with a record from each dimension
                $fact<'FactSentSms'><'dimension_time_id'> = $this->DimensionTime->getDimensionFor($one<'OutgoingSms'>);
                $fact<'FactSentSms'><'dimension_type_id'> = $this->DimensionType->getDimensionFor($one<'OutgoingSms'>);
                $fact<'FactSentSms'><'dimension_client_id'> = $this->DimensionClient->getDimensionFor($one<'OutgoingSms'>);
                $fact<'FactSentSms'><'dimension_module_id'> = $this->DimensionModule->getDimensionFor($one<'OutgoingSms'>);
                
                // Simple facts tracked
                $fact<'FactSentSms'><'response_code'> = $one<'OutgoingSms'><'response_code'>;
                $fact<'FactSentSms'><'tarif_total'> = $one<'OutgoingSms'><'data'><'tariffClass'>;
                $fact<'FactSentSms'><'outgoing_id'> = $one<'OutgoingSms'><'id'>; // copy original id so that we can do updates reliably
                $fact<'FactSentSms'><'num_smses'> = count(split_sms($one<'OutgoingSms'><'data'><'userData'>)); //WARNING. this line will fail unless you also have a function to split SMS messages

                $this->saveFact($fact);
            }
        }// end big while
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>


<h3>Dimension Models</h3>

<p>
The dimension models are often simple. They only implement one custom method (also often simple): getDimensionFor(). This method takes a single record from the transaction model and figures out which dimension it belongs to. E.G. It can look at the created field and find the right time dimension to match that timestamp. It can check the a status code and simply map to a record representing that code.
</p>


<p>
The following example is a time dimension with a daily grain. I.E. the smallest increment in time is a day. I chose this dimension as the example since it is one that can be re-used, often without modification. If you look at gather() (above) you can see that I let MySQL do all the heavy calculations to pick out the date components. The method tries to find an existing dimension record and failing that it creates a new record. Simple pimple!
</p>


<p>
This example also implements the most basic form of caching. Since the dimensions usually contain a very limited number of records caching each one in memory will dramatically increase the performance of the gathering process. Say you have the price dimension with 10 prices (that is 10 records) and 800&#8217;000 transactions to map. Evenly distributed, each price record will be queried 80&#8217;000 times. 79&#8217;999 times to many. So by caching the queries you save your database 799&#8217;990 redundant queries just for a single dimension. My simple cache is a lot faster than using cacheQueries, probably because it is so very basic. When it is all that is needed I will gladly take the performance boost.
<p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:sql </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">

CREATE TABLE `dimension_time` (
    `id` int(11) unsigned NOT NULL auto_increment,
    `day_of_week` int(11) default NULL,
    `day_of_month` int(11) default NULL,
    `day_of_year` int(11) default NULL,
    `month` int(11) default NULL,
    `quarter` int(11) default NULL,
    `year` int(11) default NULL,
    `holiday` int(1) default '0',
    `weekend` int(1) default '0',
    PRIMARY KEY  (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=52 DEFAULT CHARSET=utf8 COLLATE=utf8_binary;

</span></code></pre></td></tr></table></div></figure></notextile></div>
<br />
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
/*
 *  Time dimension with daily grain
 */
class DimensionTime extends AppModel {
    var $name = 'DimensionTime';
    var $useTable = 'dimension_time';
    //var $cacheQueries = true;
    var $dim_cache; // lesson learned: Do your own caching.

    function getDimensionFor($one) {
        if ( empty($one<'created'>) ) {
            $one<'created'> = '2000-01-01 00:00:00';            
            $one<'day_of_week'> = '1';
            $one<'day_of_month'> = '1';
            $one<'day_of_year'> = '1';
            $one<'month'> = '1';
            $one<'quarter'> = '1';
            $one<'year'> = '2000';
        }

        $dim_time = null;
        //-> add cache search here
        if ( !empty( $this->dim_cache< $one<'year'>.$one<'day_of_year'> > ) ) {
            $dim_time = $this->dim_cache< $one<'year'>.$one<'day_of_year'> >;
        }

        if ( empty($dim_time) ) {
            $dim_time = $this->find('first',array(
                'conditions' => array(
                    'DimensionTime.day_of_year' => $one<'day_of_year'>,
                    'DimensionTime.year' => $one<'year'>
                )
            ));
        }
        if ( empty($dim_time) ) {
            $dim_time<'DimensionTime'> = array(
                'day_of_week'=> $one<'day_of_week'>,
                'day_of_month'=> $one<'day_of_month'>,
                'day_of_year'=> $one<'day_of_year'>,
                'month'=> $one<'month'>,
                'quarter'=> $one<'quarter'>,
                'year'=> $one<'year'>,
                'holiday'=> -1,
                'weekend'=> ($one<'day_of_week'>>5) ? 1: 0,
            );
            $this->create($dim_time);
            $this->save($dim_time);
            $dim_time = $this->read();
        }
        //-> save to cache here     
        $this->dim_cache< $one<'year'>.$one<'day_of_year'> > = $dim_time;

        return $dim_time<'DimensionTime'><'id'>;
    }
    
}
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>
Then just rinse and repeat. Each dimension is very similar in its design. You just have to figure out what key values you need to store to define the desired &#8220;grain&#8221;. Often this is a simple as using the categories a product can be in or the different status codes returned for a message.
</p>


### A ReportsController example
<p>
This is a simple ReportsController that uses the model FactSentSms to get statistics for pretty charts in the view. (Charts will not be covered here.) The first example method below is used to load up data for stats showing how many messages have been sent per weekday. The fact you find is usually a SUM(), COUNT() or AVG() or some other SQL function.
</p>
<p>
It looks a lot like a normal find. You can use order and conditions like normal. In the first example we only way to count records where the response code is a successful transaction (you need to know our system to know exactly why they are this way). but for and error report we want the opposite.
</p>
<p>
Group takes on a slightly special meaning here. It is used to define the dimension(s) from which to view the data. In the first example simply the day of week from the time dimension. You can add more groupings to get your data returned as a multi-dimensional array, as in the modules_and_types() method.
</p>
<p>
Mapped is a nifty little thing that replaces numerical array keys (0-n) with meaningful keys like: monday-sunday or 1-7 for day of week and  1-31 for day of month. It is a bit like findList() in that it prepares your data for the table or graph in the view.
</p>
<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
class ReportsController extends AppController {
    var $name = 'Reports';
    var $uses = array('FactSentSms');
    var $billableResponseCodes = array('0','15'); // only these response codes result in a transaction.

    // show successful transactions per weekday
    function weekdays() {
        $weekly_smses = $this->FactSentSms->findFacts('Sum(FactSentSms.num_smses)',array(
            'group'=>'DimensionTime.day_of_week',
            'order'=>'DimensionTime.day_of_week',
            'conditions'=>array(
                '(FactSentSms.response_code IN ('.implode(',',$this->billableResponseCodes).') )'
            ),
            'mapped'=>true
        ));
        $this->set('weekly_smses',$weekly_smses);       
    }
    
    // show which modules (=parts of the system) have sent which types of messages
    function modules_and_types() {
        $all_modules = $this->FactSentSms->findFacts($sum,array(
            'fields' => array('Sum(FactSentSms.tarif_total) AS FactSentSms__tarif_total'), // additional fields can be defined
            'group'=>'DimensionModule.name, DimensionType.type', // multiple dimensions are possible
            'order'=>'DimensionModule.name',
            'conditions'=>array(
                '(FactSentSms.response_code IN ('.implode(',',$this->billableResponseCodes).') )'
            ),
            'mapped'=>true
        ));
        $this->set('all_modules',$all_modules);
    }
    
    // show error types for this month
    function errors_this_month() {
        $responses = $this->FactSentSms->findFacts($sum,array(
            'group'=>'FactSentSms.response_code',
            'order'=>'FactSentSms.response_code',
            'conditions'=>array(
                '(FactSentSms.response_code NOT IN ('.implode(',',$this->billableResponseCodes).') )',
                'DimensionTime.month'=>date('m'),
                'DimensionTime.year'=>date('Y')
            ),
            'mapped'=>true
        ));             
        $this->set('responses',$responses);
    }
}
</span></code></pre></td></tr></table></div></figure></notextile></div>

### Conclusion  
<p>
I hope you can start to see the benefits. Once the schema is setup we can write any number of reporting queries and &#8220;look at&#8221; the data from many different directions very quickly. For example, doing the weekly example on ≈220&#8217;000 records on our system is just over a second for the full Cake request cycle including rendering of the html. That is pretty dang good for a single (2 year old) rack server if you ask me.
</p>
<p>
If you design your dimensions cleverly they can be re-used for many fact tables. The time dimension is a prime candidate here. I can use that for all reports of all types of facts since it check for the generic created field.
</p>    

<p style="font-size:11px;">published @ <a href="http://bakery.cakephp.org/articles/view/starschema-olap-setup-for-reporting">http://bakery.cakephp.org/articles/view/starschema-olap-setup-for-reporting</a>
</p>

</div>
  
  


      </article>
    
    
      <article>
        
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/02/18/one-core-one-app-multiple-domains-for-cakephp/">One Core, One App, Multiple Domains for CakePHP</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-02-18T00:00:00+01:00" pubdate data-updated="true">Feb 18<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>
Dealing with configurations for multiple domains (environments) is always a topic for discussion. I wanted to share my way of dealing with this common problem. This will not be right for all, which is the point. If this does not suit you, there are a few links at the bottom.
</p>


<h3>What will this do?</h3>

<p>
Simplify updates using SCM (git pull anyone?).<br />
Ability to run a single vhost setting, single cake core, single app directory for multiple subdomains.<br />
Each subdomain is it&#8217;s own application not simply an alias.<br />
Can run domain-sensitive shell tasks.
</p>


<h3>Apache first.</h3>

<p>
(or whatever you use)<br />
Just create a vhost and keep adding aliases for each new domain. 
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang: </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
ServerName client1.example.com
ServerAlias client2.example.com
ServerAlias client3.example.com
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>
(I don&#8217;t like wildcards here since I want any non-existing sub-domains to point to a non-cake &#8220;error site&#8221;)
</p>


<h3>Now Cake.</h3>

<p>
The domain switching is handled in bootstrap.php by looking at the HTTP_HOST environment variable. THis is not perfect. But I think it&#8217;s preferable to something like using &#8220;SetEnv&#8221; in htaccess or the vhost. This is simply because that if Apache isn&#8217;t providing the server name then you probably can&#8217;t see the set parameter either.
Shell access, you say? Well, that is where the first of the two if clauses in bootstrap.php comes in. More on that in a minute.
</p>




<h4>bootstrap.php</h4>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
&lt;?php
// Initial defaults go at the top, for example:
Configure::write('Config.language', 'swe');


// Load domain-specific config
if ( isset($_SERVER['HTTP_HOST']) ) { // web
    $bootstrap = CONFIGS .'domains'.DS.$_SERVER['HTTP_HOST'].'.php';
} elseif ( count($_SERVER['argv']) ) { // cli
    $_SERVER['HTTP_HOST'] = $_SERVER['argv'][count($_SERVER['argv'])-1];
    $bootstrap = CONFIGS .'domains'.DS.$_SERVER['argv'][count($_SERVER['argv'])-1].'.php';
}
if ( file_exists($bootstrap) ) {
    require($bootstrap); 
} else {
    echo 'No configuration could be loaded for domain '.$_SERVER['HTTP_HOST'].'. Exiting...';
    exit;
}   


// At the bottom you can override configurations if you found you had to.
// This is also where you define defaults for constants. (keeps the if out of the domain file)
if ( !defined('CLIENT_NAME') ) {
    define('CLIENT_NAME', 'No Client');
}

</span></code></pre></td></tr></table></div></figure></notextile></div>




<h4>Domain files</h4>


<p>
In <b>app/config/</b> I create a folder called <b>domains</b>. In it, I keep each domain-specific configuration file named after each domain.
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang: </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
client1.example.com.php
client2.example.com.php
client3.example.com.php
myapp.site.php  <-- my local dev setup also gets it's own file.
myapp.local.php  <-- someone elses local setup.
</span></code></pre></td></tr></table></div></figure></notextile></div>




<h4> client1.example.com.php</h4>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
&lt;?php
// this file will mostly contain modifications of the defaults from bootstrap.php
Configure::write('Config.language', 'eng');
define('CLIENT_NAME', 'Client One');


// But this is important. I set the database setting here!
Configure::write('Database.config', array(
    'default' => array(
        'driver' => 'mysqli_ex',
        'persistent' => false,
        'host' => 'localhost',
        'port' => '',
        'login' => 'client1',
        'password' => 'client1',
        'database' => 'client1',
        'schema' => '',
        'prefix' => '',
        'encoding' => 'utf8'
    ),
    'test' => array(
        'driver' => 'mysqli_ex',
        'persistent' => false,
        'host' => 'localhost',
        'port' => '',
        'login' => 'testing',
        'password' => 'testing',
        'database' => 'probably not',
        'schema' => '',
        'prefix' => '',
        'encoding' => 'utf8'
    )
));

</span></code></pre></td></tr></table></div></figure></notextile></div>




<h4>Database settings</h4>


<p>
As you can see I set the database configuration in the domain file. I prefer this to having a long list of database settings in database.php or a second file for each domain in the domains folder. The database settings are loaded like this:
</p>




<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
&lt;?php
class DATABASE_CONFIG {
    var $default = array(
        'driver' => 'mysqli_ex',
        'persistent' => false,
        'host' => 'localhost',
        'port' => '',
        'login' => 'root',
        'password' => '',
        'database' => 'default',
        'schema' => '',
        'prefix' => '',
        'encoding' => 'utf8'
    );

    function __construct () {       
        $config = Configure::read('Database.config');
        if ( !is_array($config) ) {
            // screaming exit here?
            return;
        }
        foreach ( $config as $name=>$data ) {
            $this->$name = $data;
        }
    }
    
}

</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>
The database file dynamically creates the attributes (class-variables) from the keys in the domain-specific file. This is probably illegal php by some strict setting but I still sleep well at night. The reason I do this and not, like some other people, simply set the &#8220;default&#8221; to whatever I have in the domain-file (see links at the bottom) is that I sometimes need several databases accessible from the application. This way I can dynamically create as many as I like.
</p>


<h3>And there shall be a shell.</h3>

<p>
The shell access is always a problem. You have no server-environment available and no Cake-magic to fake it, as far as I know. The fix is simple but also the least robust part of this setup. Bootstrap is set to accept the domain as a shell argument. 
</p>


<h4>part of bootstrap.php again</h4>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
&lt;?php

if ( isset($_SERVER['HTTP_HOST']) ) { // normal web access
    $bootstrap = CONFIGS .'domains'.DS.$_SERVER['HTTP_HOST'].'.php';
} elseif ( count($_SERVER['argv']) ) { // we need a cli agrument (argv will always exist so this is a bit pointless)
    $_SERVER['HTTP_HOST'] = $_SERVER['argv'][count($_SERVER['argv'])-1];
    $bootstrap = CONFIGS .'domains'.DS.$_SERVER['argv'][count($_SERVER['argv'])-1].'.php';
}


</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>
These lines set the server name and the include file from the last shell argument. That is the less robust part and something you may wish to modify if you find it breaks your shells.
</p>


<br />


<p>
My hourly script is runs like this:
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang: </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
/path/to/cake/cake/console/cake hourly client1.example.com
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>
And from cron that would be:
</p>


<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang: </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
/path/to/cake/cake/console/cake -app /path/to/cake/app/ hourly client1.example.com
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>
I have even verified that the HTTP_HOST survives a requestAction(), good old requesrtAction ;)
</p>


<h3>Anything to look out for?</h3>

<p>
This technique works. I have used a variation of this on a live application for almost 3 years. Before devising this tweaked and updated version I looked at the suggestions from blogs and posts around the web. For my purposes this is the best I have seen. But it is not without it&#8217;s potential problems.
</p>


<br />


<p>
Caching is not exhaustively tested. I can say that Cake&#8217;s default caching of models and &#8220;persistent&#8221; things are not adversely affected. Other caching, I don&#8217;t know. You can specify &#8220;domains&#8221; for cache files which would be a way to get around problems.
</p>


<br />


<p>
Logs will be jumbled together. I have so far had to patch the CakePHP core to achieve domain-specific logs. See update below.
</p>


<br />


<p>
Uploaded files should be pointed to domain-specific folders. You don&#8217;t want a file called trade-secrets.doc to be accessed by the wrong domain!
</p>


<h3>That&#8217;s it</h3>

<p>
Thanks for reading. If you are not bored yet below are a few blog posts that I used as inspiration and reference in varying amounts.
<br /><br />
<a href="http://rafaelbandeira3.wordpress.com/2008/12/05/handling-multiple-enviroments-on-cakephp/">http://rafaelbandeira3.wordpress.com/2008/12/05/handling-multiple-enviroments-on-cakephp/</a><br />
<a href="http://www.littlehart.net/atthekeyboard/2008/11/28/handling-multiple-environments-in-your-php-application/">http://www.littlehart.net/atthekeyboard/2008/11/28/handling-multiple-environments-in-your-php-application/</a><br />
<a href="http://edwardawebb.com/programming/php-programming/cakephp/automatically-choose-database-connections-cakephp">http://edwardawebb.com/programming/php-programming/cakephp/automatically-choose-database-connections-cakephp</a>
</p>


<br /><br />


<h3>Update: Hacking the core to redirect the tmp folder</h3>

<p>
I did a minimal patch to the CakePHP (via git, updates are very painless with simple patches).
</p>




<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:xml </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
diff --git a/cake/config/paths.php b/cake/config/paths.php  
index 6a6449f..075313a 100644  
--- a/cake/config/paths.php  
+++ b/cake/config/paths.php  
@@ -46,6 +46,9 @@  
 if (!defined('APP')) {  
        define('APP', ROOT.DS.APP_DIR.DS);  
 }  
+if (file_exists(APP . 'config' . DS . 'paths.php')) {  
+       include_once APP . 'config' . DS . 'paths.php';  
+}  
 /**  
  * Path to the application's models directory.  
  */
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>
I then add the necessary file app/config/paths.php and put this into it:
</p>




<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>lang:php </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span></pre></td><td class="code"><pre><code class=><span class="line">
if ( !isset($_SERVER['SERVER_NAME']) ) { 
    if ( count($_SERVER['argv']) ) { // cli 
        $_SERVER['SERVER_NAME'] = $_SERVER['argv'][count($_SERVER['argv'])-1]; 
    } else { 
        echo 'No server name is available. Halting...'; 
        exit; 
    } 
} 

$tmp = APP.'tmp'.DS .'domains'.DS.$_SERVER['SERVER_NAME'].DS; 
    //print_r($tmp); 
if ( !is_dir($tmp) ) { 
    $old = umask(0);     
    @mkdir($tmp,0777,true); 
    @mkdir($tmp.'logs'.DS,0777,true); 
    @mkdir($tmp.'cache'.DS.'models'.DS,0777,true); 
    @mkdir($tmp.'cache'.DS.'persistent'.DS,0777,true); 
    @mkdir($tmp.'cache'.DS.'views'.DS,0777,true); 
    @mkdir($tmp.'sessions'.DS,0777,true); 
    umask($old); 
    if ( is_dir($tmp) ) { 
        if (!defined('TMP')) { 
            define('TMP', $tmp); 
        } 
    } else { 
        echo 'Specific temporary folder does not exist: '.$tmp.' - Halting...'; // ROOT.DS.APP_DIR.DS 
        exit; 
    } 
} else { 
    if (!defined('TMP')) { 
        define('TMP', $tmp); 
    } 
}
</span></code></pre></td></tr></table></div></figure></notextile></div>




<p>
This code will check that a domain-tmp exists or try to create it if it does not. Finally it defines TMP. I have kept the permissions very loose in this example. I suggest tightening it up before going public.
</p>


<p>
I had to hack the core, but that puts me into deployment nirvana. One source-tree on the server while keeping separate logs, cache, uploads and anything else kept in tmp.
</p>


<p style="font-size:11px;">published @ <a href="http://bakery.cakephp.org/articles/view/one-core-one-app-multiple-domains">http://bakery.cakephp.org/articles/view/one-core-one-app-multiple-domains</a>
</p>

</div>
  
  


      </article>
    
    <div class="pagination">
      
        <a class="prev" href="/blog/page/5/">&larr; Older</a>
      
      <a href="/blog/archives">Blog Archives</a>
      
      <a class="next" href="/blog/page/3/">Newer &rarr;</a>
      
    </div>
  </div>

  
  <div class="span4 sidebar">
    <div class="well">
      
        <section>
  <h2>Recent Posts</h2>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/17/shelling-out-from-a-ruby-app-to-a-ruby-app-without-bundler-conflicts/">Shelling out from a ruby app to a ruby app without bundler conflicts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/29/winning-two-gsma-global-mobile-awards/">Winning Two GSMA Global Mobile Awards</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/09/looping-through-large-and-slow-datasets-in-ruby/">Looping through large and slow datasets in Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/11/03/quick-tip-ios-and-web-graphics-in-illustrator/">Quick Tip: iOS and web graphics in Illustrator</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/07/26/patents-gone-crazy/">Patents Gone Crazy</a>
      </li>
    
  </ul>
</section>

<section>
  <h2>GitHub Repos</h2>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/eimermusic">@eimermusic</a> on GitHub
  
  <script type="text/javascript">
    $(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'eimermusic',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h2>Latest Tweets</h2>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
    <a href="http://twitter.com/eimer" class="twitter-follow-button" data-show-count="false">Follow @eimer</a>
  
</section>





      
    </div>
  </div>



</div>
      </div>
    </div>
    <footer class="footer"><p>
  Copyright &copy; 2013 - Martin Westin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> -
  
    <span class="credit">Theme by <a href="http://brianarmstrong.org">Brian Armstrong</a></span>
  
</p>
</footer>
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>








  </div>
</body>
</html>
